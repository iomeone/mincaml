<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=euc-jp">
  <title>
MinCaml Source Code</title>
  <meta name="GENERATOR" content="caml2html 1.2.0">
</head>
<body>
<h1><code>main.mli</code></h1>

<pre><span style="color:green">val</span> limit : int ref
<span style="color:green">val</span> string : string -&gt; unit
<span style="color:green">val</span> file : string -&gt; unit
</pre>

<hr>
<h1><code>main.ml</code></h1>
<a name="main_iter"></a>
<pre><span style="color:green">let</span> limit = ref 1000

<span style="color:green">let</span> <span style="color:green">rec</span> iter n e = <span style="color:#990000">(* 最適化処理をくりかえす *)</span>
  <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"iteration %d@."</span> n;
  <span style="color:#77aaaa">if</span> n = 0 <span style="color:#77aaaa">then</span> e <span style="color:#77aaaa">else</span>
  <span style="color:green">let</span> e' = <span style="color:#0033cc">Elim</span>.f (<span style="color:#0033cc">ConstFold</span>.f (<span style="color:#0033cc">Inline</span>.f (<span style="color:#0033cc">Assoc</span>.f (<span style="color:#0033cc">Beta</span>.f e)))) <span style="color:green">in</span>
<a name="main_lexbuf"></a>  <span style="color:#77aaaa">if</span> e = e' <span style="color:#77aaaa">then</span> e <span style="color:#77aaaa">else</span>
  iter (n - 1) e'

<span style="color:green">let</span> lexbuf outchan l = <span style="color:#990000">(* バッファをコンパイルしてチャンネルへ出力する *)</span>
  <span style="color:#0033cc">Id</span>.counter := 0;
  <span style="color:#0033cc">Typing</span>.extenv := <span style="color:#0033cc">M</span>.empty;
  <span style="color:#0033cc">Emit</span>.f outchan
    (<span style="color:#0033cc">RegAlloc</span>.f
       (<span style="color:#0033cc">Simm13</span>.f
          (<span style="color:#0033cc">Virtual</span>.f
             (<span style="color:#0033cc">Closure</span>.f
                (iter !limit
                   (<span style="color:#0033cc">Alpha</span>.f
                      (<span style="color:#0033cc">KNormal</span>.f
<a name="main_string"></a>                         (<span style="color:#0033cc">Typing</span>.f
                            (<span style="color:#0033cc">Parser</span>.exp <span style="color:#0033cc">Lexer</span>.token l)))))))))
<a name="main_file"></a>
<span style="color:green">let</span> string s = lexbuf stdout (<span style="color:#0033cc">Lexing</span>.from_string s) <span style="color:#990000">(* 文字列をコンパイルして標準出力に表示する *)</span>

<span style="color:green">let</span> file f = <span style="color:#990000">(* ファイルをコンパイルしてファイルに出力する *)</span>
  <span style="color:green">let</span> inchan = open_in (f ^ <span style="color:#aa4444">".ml"</span>) <span style="color:green">in</span>
  <span style="color:green">let</span> outchan = open_out (f ^ <span style="color:#aa4444">".s"</span>) <span style="color:green">in</span>
  <span style="color:#77aaaa">try</span>
    lexbuf outchan (<span style="color:#0033cc">Lexing</span>.from_channel inchan);
    close_in inchan;
<a name="main_entry"></a>    close_out outchan;
  <span style="color:#77aaaa">with</span> e -&gt; (close_in inchan; close_out outchan; raise e)

<span style="color:green">let</span> () = <span style="color:#990000">(* ここからコンパイラの実行が開始される *)</span>
  <span style="color:green">let</span> files = ref [] <span style="color:green">in</span>
  <span style="color:#0033cc">Arg</span>.parse
    [(<span style="color:#aa4444">"-inline"</span>, <span style="color:#0033cc">Arg</span>.<span style="color:#0033cc">Int</span>(<span style="color:green">fun</span> i -&gt; <span style="color:#0033cc">Inline</span>.threshold := i), <span style="color:#aa4444">"maximum size of functions inlined"</span>);
     (<span style="color:#aa4444">"-iter"</span>, <span style="color:#0033cc">Arg</span>.<span style="color:#0033cc">Int</span>(<span style="color:green">fun</span> i -&gt; limit := i), <span style="color:#aa4444">"maximum number of optimizations iterated"</span>)]
    (<span style="color:green">fun</span> s -&gt; files := !files @ [s])
    (<span style="color:#aa4444">"Mitou Min-Caml Compiler (C) Eijiro Sumii\n"</span> ^
     <span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"usage: %s [-inline m] [-iter n] ...filenames without \".ml\"..."</span> <span style="color:#0033cc">Sys</span>.argv.(0));
  <span style="color:#0033cc">List</span>.iter
    (<span style="color:green">fun</span> f -&gt; ignore (file f))
    !files
</pre>

<a name="id_t"></a><hr>
<a name="id_l"></a><h1><code>id.ml</code></h1>

<pre><span style="color:green">type</span> t = string <span style="color:#990000">(* 変数の名前 *)</span>
<span style="color:green">type</span> l = <span style="color:#0033cc">L</span> <span style="color:green">of</span> string <span style="color:#990000">(* トップレベル関数やグローバル配列のラベル *)</span>

<span style="color:green">let</span> <span style="color:green">rec</span> pp_list = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> [] -&gt; <span style="color:#aa4444">""</span>
  <span style="color:#77aaaa">|</span> [x] -&gt; x
  <span style="color:#77aaaa">|</span> x :: xs -&gt; x ^ <span style="color:#aa4444">" "</span> ^ pp_list xs

<span style="color:green">let</span> counter = ref 0
<span style="color:green">let</span> genid s =
  incr counter;
  <span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"%s.%d"</span> s !counter

<span style="color:green">let</span> <span style="color:green">rec</span> id_of_typ = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#aa4444">"u"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span> -&gt; <span style="color:#aa4444">"b"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> -&gt; <span style="color:#aa4444">"i"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; <span style="color:#aa4444">"d"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span> _ -&gt; <span style="color:#aa4444">"f"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span> _ -&gt; <span style="color:#aa4444">"t"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span> _ -&gt; <span style="color:#aa4444">"a"</span> 
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span> _ -&gt; <span style="color:#cc9900">assert</span> false
<span style="color:green">let</span> gentmp typ =
  incr counter;
  <span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"T%s%d"</span> (id_of_typ typ) !counter
</pre>

<hr>
<h1><code>m.ml</code></h1>

<pre><span style="color:#990000">(* customized version of Map *)</span>

<span style="color:green">module</span> <span style="color:#0033cc">M</span> =
  <span style="color:#0033cc">Map</span>.<span style="color:#0033cc">Make</span>
    (<span style="color:#990099">struct</span>
      <span style="color:green">type</span> t = <span style="color:#0033cc">Id</span>.t
      <span style="color:green">let</span> compare = compare
    <span style="color:#990099">end</span>)
<span style="color:#cc9900">include</span> <span style="color:#0033cc">M</span>

<span style="color:green">let</span> add_list xys env = <span style="color:#0033cc">List</span>.fold_left (<span style="color:green">fun</span> env (x, y) -&gt; add x y env) env xys
<span style="color:green">let</span> add_list2 xs ys env = <span style="color:#0033cc">List</span>.fold_left2 (<span style="color:green">fun</span> env x y -&gt; add x y env) env xs ys
</pre>

<hr>
<h1><code>s.ml</code></h1>

<pre><span style="color:#990000">(* customized version of Set *)</span>

<span style="color:green">module</span> <span style="color:#0033cc">S</span> =
  <span style="color:#0033cc">Set</span>.<span style="color:#0033cc">Make</span>
    (<span style="color:#990099">struct</span>
      <span style="color:green">type</span> t = <span style="color:#0033cc">Id</span>.t
      <span style="color:green">let</span> compare = compare
    <span style="color:#990099">end</span>)
<span style="color:#cc9900">include</span> <span style="color:#0033cc">S</span>

<span style="color:green">let</span> of_list l = <span style="color:#0033cc">List</span>.fold_left (<span style="color:green">fun</span> s e -&gt; add e s) empty l
</pre>

<a name="syntax_t"></a><hr>
<h1><code>syntax.ml</code></h1>

<pre><span style="color:green">type</span> t = <span style="color:#990000">(* MinCamlの構文を表現するデータ型 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Bool</span> <span style="color:green">of</span> bool
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span> <span style="color:green">of</span> float
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Not</span> <span style="color:green">of</span> t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span> <span style="color:green">of</span> t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Eq</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NEq</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Lt</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LE</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">If</span> <span style="color:green">of</span> t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span> <span style="color:green">of</span> fundef list * t <span style="color:#990000">(* mutual recursion *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span> <span style="color:green">of</span> t * t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span> <span style="color:green">of</span> t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Array</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span> <span style="color:green">of</span> t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span> <span style="color:green">of</span> t * t * t
<span style="color:green">and</span> fundef = { name : <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t; args : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list; body : t }
</pre>

<a name="type_t"></a><hr>
<h1><code>type.ml</code></h1>

<pre><span style="color:green">type</span> t = <span style="color:#990000">(* MinCamlの型を表現するデータ型 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Bool</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Fun</span> <span style="color:green">of</span> t list * t <span style="color:#990000">(* arguments are uncurried *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span> <span style="color:green">of</span> t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Array</span> <span style="color:green">of</span> t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span> <span style="color:green">of</span> t option ref

<span style="color:green">let</span> gentyp () = <span style="color:#0033cc">Var</span>(ref <span style="color:#0033cc">None</span>) <span style="color:#990000">(* 新しい型変数を作る *)</span>
</pre>

<hr>
<h1><code>parser.mly</code></h1>

<pre>%{
<span style="color:#990000">(* parserが利用する変数、関数、型などの定義 *)</span>
<span style="color:#cc9900">open</span> <span style="color:#0033cc">Syntax</span>
<a name="parser_token"></a><span style="color:green">let</span> addtyp x = (x, <span style="color:#0033cc">Type</span>.gentyp ())
%}

<span style="color:#990000">/* 字句を表すデータ型の定義 */</span>
%token &lt;bool&gt; <span style="color:#0033cc">BOOL</span>
%token &lt;int&gt; <span style="color:#0033cc">INT</span>
%token &lt;float&gt; <span style="color:#0033cc">FLOAT</span>
%token <span style="color:#0033cc">NOT</span>
%token <span style="color:#0033cc">MINUS</span>
%token <span style="color:#0033cc">PLUS</span>
%token <span style="color:#0033cc">MINUS_DOT</span>
%token <span style="color:#0033cc">PLUS_DOT</span>
%token <span style="color:#0033cc">AST_DOT</span>
%token <span style="color:#0033cc">SLASH_DOT</span>
%token <span style="color:#0033cc">EQUAL</span>
%token <span style="color:#0033cc">LESS_GREATER</span>
%token <span style="color:#0033cc">LESS_EQUAL</span>
%token <span style="color:#0033cc">GREATER_EQUAL</span>
%token <span style="color:#0033cc">LESS</span>
%token <span style="color:#0033cc">GREATER</span>
%token <span style="color:#0033cc">IF</span>
%token <span style="color:#0033cc">THEN</span>
%token <span style="color:#0033cc">ELSE</span>
%token &lt;<span style="color:#0033cc">Id</span>.t&gt; <span style="color:#0033cc">IDENT</span>
%token <span style="color:#0033cc">LET</span>
%token <span style="color:#0033cc">IN</span>
%token <span style="color:#0033cc">REC</span>
%token <span style="color:#0033cc">AND</span>
%token <span style="color:#0033cc">COMMA</span>
%token <span style="color:#0033cc">ARRAY_CREATE</span>
%token <span style="color:#0033cc">DOT</span>
%token <span style="color:#0033cc">LESS_MINUS</span>
%token <span style="color:#0033cc">SEMICOLON</span>
%token <span style="color:#0033cc">LPAREN</span>
<a name="parser_prior"></a>%token <span style="color:#0033cc">RPAREN</span>
%token <span style="color:#0033cc">EOF</span>

<span style="color:#990000">/* 優先順位とassociativityの定義（低い方から高い方へ） */</span>
%right prec_let
%right <span style="color:#0033cc">SEMICOLON</span>
%right prec_if
%right <span style="color:#0033cc">LESS_MINUS</span>
%left <span style="color:#0033cc">COMMA</span>
%left <span style="color:#0033cc">EQUAL</span> <span style="color:#0033cc">LESS_GREATER</span> <span style="color:#0033cc">LESS</span> <span style="color:#0033cc">GREATER</span> <span style="color:#0033cc">LESS_EQUAL</span> <span style="color:#0033cc">GREATER_EQUAL</span>
%left <span style="color:#0033cc">PLUS</span> <span style="color:#0033cc">MINUS</span> <span style="color:#0033cc">PLUS_DOT</span> <span style="color:#0033cc">MINUS_DOT</span>
%left <span style="color:#0033cc">AST_DOT</span> <span style="color:#0033cc">SLASH_DOT</span>
%right prec_unary_minus
%left prec_app
%left <span style="color:#0033cc">DOT</span>

<span style="color:#990000">/* 開始記号の定義 */</span>
%<span style="color:green">type</span> &lt;<span style="color:#0033cc">Syntax</span>.t&gt; exp
%start exp
<a name="parser_simple"></a>
%%

simple_exp: <span style="color:#990000">/* 括弧をつけなくても関数の引数になれる式 */</span>
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">LPAREN</span> exp <span style="color:#0033cc">RPAREN</span>
    { $2 }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">LPAREN</span> <span style="color:#0033cc">RPAREN</span>
    { <span style="color:#0033cc">Unit</span> }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">BOOL</span>
    { <span style="color:#0033cc">Bool</span>($1) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">INT</span>
    { <span style="color:#0033cc">Int</span>($1) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">FLOAT</span>
    { <span style="color:#0033cc">Float</span>($1) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IDENT</span>
    { <span style="color:#0033cc">Var</span>($1) }
<a name="parser_exp"></a><span style="color:#77aaaa">|</span> simple_exp <span style="color:#0033cc">DOT</span> <span style="color:#0033cc">LPAREN</span> exp <span style="color:#0033cc">RPAREN</span>
    { <span style="color:#0033cc">Get</span>($1, $4) }

exp: <span style="color:#990000">/* 一般の式 */</span>
<span style="color:#77aaaa">|</span> simple_exp
    { $1 }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">NOT</span> exp
    %prec prec_app
    { <span style="color:#0033cc">Not</span>($2) }
<a name="parser_add"></a><span style="color:#77aaaa">|</span> <span style="color:#0033cc">MINUS</span> exp
    %prec prec_unary_minus
    { <span style="color:#0033cc">Neg</span>($2) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">PLUS</span> exp <span style="color:#990000">/* 足し算を構文解析するルール */</span>
    { <span style="color:#0033cc">Add</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">MINUS</span> exp
    { <span style="color:#0033cc">Sub</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">EQUAL</span> exp
    { <span style="color:#0033cc">Eq</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">LESS_GREATER</span> exp
    { <span style="color:#0033cc">NEq</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">LESS</span> exp
    { <span style="color:#0033cc">Lt</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">GREATER</span> exp
    { <span style="color:#0033cc">Lt</span>($3, $1) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">LESS_EQUAL</span> exp
    { <span style="color:#0033cc">LE</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">GREATER_EQUAL</span> exp
    { <span style="color:#0033cc">LE</span>($3, $1) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IF</span> exp <span style="color:#0033cc">THEN</span> exp <span style="color:#0033cc">ELSE</span> exp
    %prec prec_if
    { <span style="color:#0033cc">If</span>($2, $4, $6) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">MINUS_DOT</span> exp
    %prec prec_unary_minus
    { <span style="color:#0033cc">FNeg</span>($2) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">PLUS_DOT</span> exp
    { <span style="color:#0033cc">FAdd</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">MINUS_DOT</span> exp
    { <span style="color:#0033cc">FSub</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">AST_DOT</span> exp
    { <span style="color:#0033cc">FMul</span>($1, $3) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">SLASH_DOT</span> exp
    { <span style="color:#0033cc">FDiv</span>($1, $3) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">LET</span> <span style="color:#0033cc">IDENT</span> <span style="color:#0033cc">EQUAL</span> exp <span style="color:#0033cc">IN</span> exp
    %prec prec_let
    { <span style="color:#0033cc">Let</span>(addtyp $2, $4, $6) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">LET</span> <span style="color:#0033cc">REC</span> fundefs <span style="color:#0033cc">IN</span> exp
    %prec prec_let
    { <span style="color:#0033cc">LetRec</span>($3, $5) }
<span style="color:#77aaaa">|</span> exp actual_args
    %prec prec_app
    { <span style="color:#0033cc">App</span>($1, $2) }
<span style="color:#77aaaa">|</span> elems
    { <span style="color:#0033cc">Tuple</span>($1) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">LET</span> <span style="color:#0033cc">LPAREN</span> pat <span style="color:#0033cc">RPAREN</span> <span style="color:#0033cc">EQUAL</span> exp <span style="color:#0033cc">IN</span> exp
    { <span style="color:#0033cc">LetTuple</span>($3, $6, $8) }
<span style="color:#77aaaa">|</span> simple_exp <span style="color:#0033cc">DOT</span> <span style="color:#0033cc">LPAREN</span> exp <span style="color:#0033cc">RPAREN</span> <span style="color:#0033cc">LESS_MINUS</span> exp
    { <span style="color:#0033cc">Put</span>($1, $4, $7) }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">SEMICOLON</span> exp
    { <span style="color:#0033cc">Let</span>((<span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>), $1, $3) }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">ARRAY_CREATE</span> simple_exp simple_exp
    %prec prec_app
    { <span style="color:#0033cc">Array</span>($2, $3) }
<span style="color:#77aaaa">|</span> error
    { failwith
        (<span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"parse error near characters %d-%d"</span>
           (<span style="color:#0033cc">Parsing</span>.symbol_start ())
           (<span style="color:#0033cc">Parsing</span>.symbol_end ())) }

fundefs:
<span style="color:#77aaaa">|</span> fundef <span style="color:#0033cc">AND</span> fundefs
    { $1 :: $3 }
<span style="color:#77aaaa">|</span> fundef
    { [$1] }

fundef:
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IDENT</span> formal_args <span style="color:#0033cc">EQUAL</span> exp
    { { name = addtyp $1; args = $2; body = $4 } }

formal_args:
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IDENT</span> formal_args
    { addtyp $1 :: $2 }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IDENT</span>
    { [addtyp $1] }

actual_args:
<span style="color:#77aaaa">|</span> actual_args simple_exp
    %prec prec_app
    { $1 @ [$2] }
<span style="color:#77aaaa">|</span> simple_exp
    %prec prec_app
    { [$1] }

elems:
<span style="color:#77aaaa">|</span> elems <span style="color:#0033cc">COMMA</span> exp
    { $1 @ [$3] }
<span style="color:#77aaaa">|</span> exp <span style="color:#0033cc">COMMA</span> exp
    { [$1; $3] }

pat:
<span style="color:#77aaaa">|</span> pat <span style="color:#0033cc">COMMA</span> <span style="color:#0033cc">IDENT</span>
    { $1 @ [addtyp $3] }
<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IDENT</span> <span style="color:#0033cc">COMMA</span> <span style="color:#0033cc">IDENT</span>
    { [addtyp $1; addtyp $3] }
</pre>

<hr>
<h1><code>lexer.mll</code></h1>

<pre>{
<span style="color:#990000">(* lexerが利用する変数、関数、型などの定義 *)</span>
<span style="color:#cc9900">open</span> <span style="color:#0033cc">Parser</span>
<span style="color:#cc9900">open</span> <span style="color:#0033cc">Type</span>
}

<span style="color:#990000">(* 正規表現の略記 *)</span>
<span style="color:green">let</span> space = [<span style="color:#aa4444">' '</span> <span style="color:#aa4444">'\t'</span> <span style="color:#aa4444">'\n'</span> <span style="color:#aa4444">'\r'</span>]
<span style="color:green">let</span> digit = [<span style="color:#aa4444">'0'</span>-<span style="color:#aa4444">'9'</span>]
<span style="color:green">let</span> lower = [<span style="color:#aa4444">'a'</span>-<span style="color:#aa4444">'z'</span>]
<span style="color:green">let</span> upper = [<span style="color:#aa4444">'A'</span>-<span style="color:#aa4444">'Z'</span>]

rule token = parse
<span style="color:#77aaaa">|</span> space+
    { token lexbuf }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"(*"</span>
    { comment lexbuf; <span style="color:#990000">(* ネストしたコメントのためのトリック *)</span>
      token lexbuf }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'('</span>
    { <span style="color:#0033cc">LPAREN</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">')'</span>
    { <span style="color:#0033cc">RPAREN</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"true"</span>
    { <span style="color:#0033cc">BOOL</span>(true) }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"false"</span>
<a name="lexer_int"></a>    { <span style="color:#0033cc">BOOL</span>(false) }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"not"</span>
    { <span style="color:#0033cc">NOT</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'-'</span>? digit+ <span style="color:#990000">(* 整数を字句解析するルール *)</span>
    { <span style="color:#0033cc">INT</span>(int_of_string (<span style="color:#0033cc">Lexing</span>.lexeme lexbuf)) }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'-'</span>? digit+ (<span style="color:#aa4444">'.'</span> digit*)? ([<span style="color:#aa4444">'e'</span> <span style="color:#aa4444">'E'</span>] [<span style="color:#aa4444">'+'</span> <span style="color:#aa4444">'-'</span>]? digit+)?
    { <span style="color:#0033cc">FLOAT</span>(float_of_string (<span style="color:#0033cc">Lexing</span>.lexeme lexbuf)) }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'-'</span> <span style="color:#990000">(* -.より後回しにしなくても良い? 最長一致? *)</span>
    { <span style="color:#0033cc">MINUS</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'+'</span> <span style="color:#990000">(* +.より後回しにしなくても良い? 最長一致? *)</span>
    { <span style="color:#0033cc">PLUS</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"-."</span>
    { <span style="color:#0033cc">MINUS_DOT</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"+."</span>
    { <span style="color:#0033cc">PLUS_DOT</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"*."</span>
    { <span style="color:#0033cc">AST_DOT</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"/."</span>
    { <span style="color:#0033cc">SLASH_DOT</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'='</span>
    { <span style="color:#0033cc">EQUAL</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"&lt;&gt;"</span>
    { <span style="color:#0033cc">LESS_GREATER</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"&lt;="</span>
    { <span style="color:#0033cc">LESS_EQUAL</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"&gt;="</span>
    { <span style="color:#0033cc">GREATER_EQUAL</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'&lt;'</span>
    { <span style="color:#0033cc">LESS</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'&gt;'</span>
    { <span style="color:#0033cc">GREATER</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"if"</span>
    { <span style="color:#0033cc">IF</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"then"</span>
    { <span style="color:#0033cc">THEN</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"else"</span>
    { <span style="color:#0033cc">ELSE</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"let"</span>
    { <span style="color:#0033cc">LET</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"in"</span>
    { <span style="color:#0033cc">IN</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"rec"</span>
    { <span style="color:#0033cc">REC</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"and"</span>
    { <span style="color:#0033cc">AND</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">','</span>
    { <span style="color:#0033cc">COMMA</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'_'</span>
    { <span style="color:#0033cc">IDENT</span>(<span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>) }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"Array.create"</span> <span style="color:#990000">(* [XX] ad hoc *)</span>
    { <span style="color:#0033cc">ARRAY_CREATE</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">'.'</span>
    { <span style="color:#0033cc">DOT</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"&lt;-"</span>
    { <span style="color:#0033cc">LESS_MINUS</span> }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">';'</span>
    { <span style="color:#0033cc">SEMICOLON</span> }
<span style="color:#77aaaa">|</span> eof
    { <span style="color:#0033cc">EOF</span> }
<span style="color:#77aaaa">|</span> lower (digit<span style="color:#77aaaa">|</span>lower<span style="color:#77aaaa">|</span>upper<span style="color:#77aaaa">|</span><span style="color:#aa4444">'_'</span>)* <span style="color:#990000">(* 他の「予約語」より後でないといけない *)</span>
    { <span style="color:#0033cc">IDENT</span>(<span style="color:#0033cc">Lexing</span>.lexeme lexbuf) }
<span style="color:#77aaaa">|</span> _
    { failwith
        (<span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"unknown token %s near characters %d-%d"</span>
           (<span style="color:#0033cc">Lexing</span>.lexeme lexbuf)
           (<span style="color:#0033cc">Lexing</span>.lexeme_start lexbuf)
           (<span style="color:#0033cc">Lexing</span>.lexeme_end lexbuf)) }
<span style="color:green">and</span> comment = parse
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"*)"</span>
    { () }
<span style="color:#77aaaa">|</span> <span style="color:#aa4444">"(*"</span>
    { comment lexbuf;
      comment lexbuf }
<span style="color:#77aaaa">|</span> eof
    { <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"warning: unterminated comment@."</span> }
<span style="color:#77aaaa">|</span> _
    { comment lexbuf }
</pre>

<hr>
<h1><code>typing.mli</code></h1>

<pre><span style="color:green">exception</span> <span style="color:#0033cc">Error</span> <span style="color:green">of</span> <span style="color:#0033cc">Syntax</span>.t * <span style="color:#0033cc">Type</span>.t * <span style="color:#0033cc">Type</span>.t
<span style="color:green">val</span> extenv : <span style="color:#0033cc">Type</span>.t <span style="color:#0033cc">M</span>.t ref
<span style="color:green">val</span> f : <span style="color:#0033cc">Syntax</span>.t -&gt; <span style="color:#0033cc">Syntax</span>.t
</pre>

<hr>
<h1><code>typing.ml</code></h1>

<pre><span style="color:#990000">(* type inference/reconstruction *)</span>

<span style="color:#cc9900">open</span> <span style="color:#0033cc">Syntax</span>

<span style="color:green">exception</span> <span style="color:#0033cc">Unify</span> <span style="color:green">of</span> <span style="color:#0033cc">Type</span>.t * <span style="color:#0033cc">Type</span>.t
<span style="color:green">exception</span> <span style="color:#0033cc">Error</span> <span style="color:green">of</span> t * <span style="color:#0033cc">Type</span>.t * <span style="color:#0033cc">Type</span>.t

<a name="typing_deref"></a><span style="color:green">let</span> extenv = ref <span style="color:#0033cc">M</span>.empty

<span style="color:#990000">(* for pretty printing (and type normalization) *)</span>
<span style="color:green">let</span> <span style="color:green">rec</span> deref_typ = <span style="color:green">function</span> <span style="color:#990000">(* 型変数を中身でおきかえる関数 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(t1s, t2) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(<span style="color:#0033cc">List</span>.map deref_typ t1s, deref_typ t2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(ts) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map deref_typ ts)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(deref_typ t)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">None</span> } <span style="color:green">as</span> r) -&gt;
      <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"uninstantiated type variable detected; assuming int@."</span>;
      r := <span style="color:#0033cc">Some</span>(<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>);
      <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">Some</span>(t) } <span style="color:green">as</span> r) -&gt;
      <span style="color:green">let</span> t' = deref_typ t <span style="color:green">in</span>
      r := <span style="color:#0033cc">Some</span>(t');
      t'
  <span style="color:#77aaaa">|</span> t -&gt; t
<span style="color:green">let</span> <span style="color:green">rec</span> deref_id_typ (x, t) = (x, deref_typ t)
<span style="color:green">let</span> <span style="color:green">rec</span> deref_term = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Not</span>(e) -&gt; <span style="color:#0033cc">Not</span>(deref_term e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(e) -&gt; <span style="color:#0033cc">Neg</span>(deref_term e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(e1, e2) -&gt; <span style="color:#0033cc">Add</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(e1, e2) -&gt; <span style="color:#0033cc">Sub</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Eq</span>(e1, e2) -&gt; <span style="color:#0033cc">Eq</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NEq</span>(e1, e2) -&gt; <span style="color:#0033cc">NEq</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Lt</span>(e1, e2) -&gt; <span style="color:#0033cc">Lt</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LE</span>(e1, e2) -&gt; <span style="color:#0033cc">LE</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(e) -&gt; <span style="color:#0033cc">FNeg</span>(deref_term e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(e1, e2) -&gt; <span style="color:#0033cc">FAdd</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(e1, e2) -&gt; <span style="color:#0033cc">FSub</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(e1, e2) -&gt; <span style="color:#0033cc">FMul</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(e1, e2) -&gt; <span style="color:#0033cc">FDiv</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">If</span>(e1, e2, e3) -&gt; <span style="color:#0033cc">If</span>(deref_term e1, deref_term e2, deref_term e3)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(xt, e1, e2) -&gt; <span style="color:#0033cc">Let</span>(deref_id_typ xt, deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt;
      <span style="color:#0033cc">LetRec</span>(<span style="color:#0033cc">List</span>.map
               (<span style="color:green">fun</span> { name = xt; args = yts; body = e1 } -&gt;
                 { name = deref_id_typ xt;
                   args = <span style="color:#0033cc">List</span>.map deref_id_typ yts;
                   body = deref_term e1 })
               fundefs,
             deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span>(e, es) -&gt; <span style="color:#0033cc">App</span>(deref_term e, <span style="color:#0033cc">List</span>.map deref_term es)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span>(es) -&gt; <span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map deref_term es)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, e1, e2) -&gt; <span style="color:#0033cc">LetTuple</span>(<span style="color:#0033cc">List</span>.map deref_id_typ xts, deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Array</span>(e1, e2) -&gt; <span style="color:#0033cc">Array</span>(deref_term e1, deref_term e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span>(e1, e2) -&gt; <span style="color:#0033cc">Get</span>(deref_term e1, deref_term e2)
<a name="typing_occur"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span>(e1, e2, e3) -&gt; <span style="color:#0033cc">Put</span>(deref_term e1, deref_term e2, deref_term e3)
  <span style="color:#77aaaa">|</span> e -&gt; e

<span style="color:green">let</span> <span style="color:green">rec</span> occur r1 = <span style="color:green">function</span> <span style="color:#990000">(* occur check *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(t2s, t2) -&gt; <span style="color:#0033cc">List</span>.exists (occur r1) t2s || occur r1 t2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(t2s) -&gt; <span style="color:#0033cc">List</span>.exists (occur r1) t2s
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t2) -&gt; occur r1 t2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>(r2) <span style="color:#77aaaa">when</span> r1 == r2 -&gt; true
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">None</span> }) -&gt; false
<a name="typing_unify"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">Some</span>(t2) }) -&gt; occur r1 t2
  <span style="color:#77aaaa">|</span> _ -&gt; false

<span style="color:green">let</span> <span style="color:green">rec</span> unify t1 t2 = <span style="color:#990000">(* 型が合うように、型変数への代入をする *)</span>
  <span style="color:#77aaaa">match</span> t1, t2 <span style="color:#77aaaa">with</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; ()
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(t1s, t1'), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(t2s, t2') -&gt;
      (<span style="color:#77aaaa">try</span> <span style="color:#0033cc">List</span>.iter2 unify t1s t2s
      <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Invalid_argument</span>(<span style="color:#aa4444">"List.iter2"</span>) -&gt; raise (<span style="color:#0033cc">Unify</span>(t1, t2)));
      unify t1' t2'
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(t1s), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(t2s) -&gt;
      (<span style="color:#77aaaa">try</span> <span style="color:#0033cc">List</span>.iter2 unify t1s t2s
      <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Invalid_argument</span>(<span style="color:#aa4444">"List.iter2"</span>) -&gt; raise (<span style="color:#0033cc">Unify</span>(t1, t2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t1), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t2) -&gt; unify t1 t2
<a name="typing_undef"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>(r1), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>(r2) <span style="color:#77aaaa">when</span> r1 == r2 -&gt; ()
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">Some</span>(t1') }), _ -&gt; unify t1' t2
  <span style="color:#77aaaa">|</span> _, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">Some</span>(t2') }) -&gt; unify t1 t2'
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">None</span> } <span style="color:green">as</span> r1), _ -&gt; <span style="color:#990000">(* 一方が未定義の型変数の場合 *)</span>
      <span style="color:#77aaaa">if</span> occur r1 t2 <span style="color:#77aaaa">then</span> raise (<span style="color:#0033cc">Unify</span>(t1, t2));
      r1 := <span style="color:#0033cc">Some</span>(t2)
  <span style="color:#77aaaa">|</span> _, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Var</span>({ contents = <span style="color:#0033cc">None</span> } <span style="color:green">as</span> r2) -&gt;
      <span style="color:#77aaaa">if</span> occur r2 t1 <span style="color:#77aaaa">then</span> raise (<span style="color:#0033cc">Unify</span>(t1, t2));
<a name="typing_g"></a>      r2 := <span style="color:#0033cc">Some</span>(t1)
  <span style="color:#77aaaa">|</span> _, _ -&gt; raise (<span style="color:#0033cc">Unify</span>(t1, t2))

<span style="color:green">let</span> <span style="color:green">rec</span> g env e = <span style="color:#990000">(* 型推論ルーチン *)</span>
  <span style="color:#77aaaa">try</span>
    <span style="color:#77aaaa">match</span> e <span style="color:#77aaaa">with</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Bool</span>(_) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span>(_) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span>(_) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Not</span>(e) -&gt;
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span> (g env e);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span>
<a name="typing_add"></a>    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(e) -&gt;
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> (g env e);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(e1, e2) -&gt; <span style="color:#990000">(* 足し算（と引き算）の型推論 *)</span>
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> (g env e1);
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> (g env e2);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(e) -&gt;
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> (g env e);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(e1, e2) -&gt;
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> (g env e1);
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> (g env e2);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Eq</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NEq</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Lt</span>(e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LE</span>(e1, e2) -&gt;
        unify (g env e1) (g env e2);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">If</span>(e1, e2, e3) -&gt;
        unify (g env e1) <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span>;
        <span style="color:green">let</span> t2 = g env e2 <span style="color:green">in</span>
<a name="typing_let"></a>        <span style="color:green">let</span> t3 = g env e3 <span style="color:green">in</span>
        unify t2 t3;
        t2
<a name="typing_var"></a>    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#990000">(* letの型推論 *)</span>
        unify t (g env e1);
<a name="typing_extvar"></a>        g (<span style="color:#0033cc">M</span>.add x t env) e2
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#0033cc">M</span>.find x env <span style="color:#990000">(* 変数の型推論 *)</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x !extenv -&gt; <span style="color:#0033cc">M</span>.find x !extenv
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#990000">(* 外部変数の型推論 *)</span>
        <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"free variable %s assumed as external@."</span> x;
<a name="typing_letrec"></a>        <span style="color:green">let</span> t = <span style="color:#0033cc">Type</span>.gentyp () <span style="color:green">in</span>
        extenv := <span style="color:#0033cc">M</span>.add x t !extenv;
        t
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt; <span style="color:#990000">(* let recの型推論 *)</span>
        <span style="color:green">let</span> env =
          <span style="color:#0033cc">M</span>.add_list
            (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> fundef -&gt; fundef.name) fundefs)
            env <span style="color:green">in</span>
        <span style="color:#0033cc">List</span>.iter
          (<span style="color:green">fun</span> { name = (x, t); args = yts; body = e1 } -&gt;
<a name="typing_app"></a>            unify t (<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(<span style="color:#0033cc">List</span>.map snd yts, g (<span style="color:#0033cc">M</span>.add_list yts env) e1)))
          fundefs;
        g env e2
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span>(e, es) -&gt; <span style="color:#990000">(* 関数適用の型推論 *)</span>
        <span style="color:green">let</span> t = <span style="color:#0033cc">Type</span>.gentyp () <span style="color:green">in</span>
        unify (g env e) (<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(<span style="color:#0033cc">List</span>.map (g env) es, t));
        t
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span>(es) -&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map (g env) es)
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, e1, e2) -&gt;
        unify (<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map snd xts)) (g env e1);
        g (<span style="color:#0033cc">M</span>.add_list xts env) e2
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Array</span>(e1, e2) -&gt; <span style="color:#990000">(* must be a primitive for "polymorphic" typing *)</span>
        unify (g env e1) <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>;
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(g env e2)
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span>(e1, e2) -&gt;
        <span style="color:green">let</span> t = <span style="color:#0033cc">Type</span>.gentyp () <span style="color:green">in</span>
        unify (<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t)) (g env e1);
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> (g env e2);
        t
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span>(e1, e2, e3) -&gt;
        <span style="color:green">let</span> t = g env e3 <span style="color:green">in</span>
        unify (<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t)) (g env e1);
        unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> (g env e2);
        <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Unify</span>(t1, t2) -&gt; raise (<span style="color:#0033cc">Error</span>(deref_term e, deref_typ t1, deref_typ t2))

<span style="color:green">let</span> f e =
  extenv := <span style="color:#0033cc">M</span>.empty;
<span style="color:#990000">(*</span>
<span style="color:#990000">  (match deref_typ (g M.empty e) with</span>
<span style="color:#990000">  | Type.Unit -&gt; ()</span>
<span style="color:#990000">  | _ -&gt; Format.eprintf "warning: final result does not have type unit@.");</span>
<span style="color:#990000">*)</span>
  (<span style="color:#77aaaa">try</span> unify <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> (g <span style="color:#0033cc">M</span>.empty e)
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Unify</span> _ -&gt; failwith <span style="color:#aa4444">"top level does not have type unit"</span>);
  extenv := <span style="color:#0033cc">M</span>.map deref_typ !extenv;
  deref_term e
</pre>

<hr>
<h1><code>kNormal.mli</code></h1>

<pre><span style="color:green">type</span> t =
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span> <span style="color:green">of</span> float
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span> <span style="color:green">of</span> fundef list * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list * <span style="color:#0033cc">Id</span>.t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtFunApp</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list
<span style="color:green">and</span> fundef = { name : <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t; args : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list; body : t }

<span style="color:green">val</span> fv : t -&gt; <span style="color:#0033cc">S</span>.t
<span style="color:green">val</span> f : <span style="color:#0033cc">Syntax</span>.t -&gt; t
</pre>

<hr>
<h1><code>kNormal.ml</code></h1>
<a name="knormal_t"></a>
<pre><span style="color:#990000">(* give names to intermediate values (K-normalization) *)</span>

<span style="color:green">type</span> t = <span style="color:#990000">(* K正規化後の式 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span> <span style="color:green">of</span> float
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
<a name="knormal_branch"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t <span style="color:#990000">(* 比較 + 分岐 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t <span style="color:#990000">(* 比較 + 分岐 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span> <span style="color:green">of</span> fundef list * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list * <span style="color:#0033cc">Id</span>.t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
<a name="knormal_fv"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtFunApp</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list
<span style="color:green">and</span> fundef = { name : <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t; args : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list; body : t }

<span style="color:green">let</span> <span style="color:green">rec</span> fv = <span style="color:green">function</span> <span style="color:#990000">(* 式に出現する（自由な）変数 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span>(_) -&gt; <span style="color:#0033cc">S</span>.empty
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(x) -&gt; <span style="color:#0033cc">S</span>.singleton x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span>(x, y) -&gt; <span style="color:#0033cc">S</span>.of_list [x; y]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">S</span>.add x (<span style="color:#0033cc">S</span>.add y (<span style="color:#0033cc">S</span>.union (fv e1) (fv e2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#0033cc">S</span>.union (fv e1) (<span style="color:#0033cc">S</span>.remove x (fv e2))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#0033cc">S</span>.singleton x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt;
      <span style="color:green">let</span> (xs, zs) =
        <span style="color:#0033cc">List</span>.fold_left
          (<span style="color:green">fun</span> (xs, zs) { name = (x, t); args = yts; body = e1 } -&gt;
            (<span style="color:#0033cc">S</span>.add x xs,
             <span style="color:#0033cc">S</span>.union zs (<span style="color:#0033cc">S</span>.diff (fv e1) (<span style="color:#0033cc">S</span>.of_list (<span style="color:#0033cc">List</span>.map fst yts)))))
          (<span style="color:#0033cc">S</span>.empty, <span style="color:#0033cc">S</span>.empty)
          fundefs <span style="color:green">in</span>
      <span style="color:#0033cc">S</span>.diff (<span style="color:#0033cc">S</span>.union zs (fv e2)) xs
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span>(x, ys) -&gt; <span style="color:#0033cc">S</span>.of_list (x :: ys)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span>(xs) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtFunApp</span>(_, xs) -&gt; <span style="color:#0033cc">S</span>.of_list xs
<a name="knormal_insert"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span>(x, y, z) -&gt; <span style="color:#0033cc">S</span>.of_list [x; y; z]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xs, y, e) -&gt; <span style="color:#0033cc">S</span>.add y (<span style="color:#0033cc">S</span>.diff (fv e) (<span style="color:#0033cc">S</span>.of_list (<span style="color:#0033cc">List</span>.map fst xs)))

<span style="color:green">let</span> insert_let (e, t) k = <span style="color:#990000">(* letを挿入する補助関数 *)</span>
  <span style="color:#77aaaa">match</span> e <span style="color:#77aaaa">with</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) -&gt; k x
  <span style="color:#77aaaa">|</span> _ -&gt;
      <span style="color:green">let</span> x = <span style="color:#0033cc">Id</span>.gentmp t <span style="color:green">in</span>
<a name="knormal_g"></a>      <span style="color:green">let</span> e', t' = k x <span style="color:green">in</span>
      <span style="color:#0033cc">Let</span>((x, t), e, e'), t'
<a name="knormal_bool"></a>
<span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* K正規化ルーチン本体 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Unit</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Bool</span>(b) -&gt; <span style="color:#0033cc">Int</span>(<span style="color:#77aaaa">if</span> b <span style="color:#77aaaa">then</span> 1 <span style="color:#77aaaa">else</span> 0), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> <span style="color:#990000">(* 論理値true, falseを整数1, 0に変換 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Int</span>(i) -&gt; <span style="color:#0033cc">Int</span>(i), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Float</span>(d) -&gt; <span style="color:#0033cc">Float</span>(d), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Not</span>(e) -&gt; g env (<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(e, <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Bool</span>(false), <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Bool</span>(true)))
<a name="knormal_add"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Neg</span>(e) -&gt;
      insert_let (g env e)
        (<span style="color:green">fun</span> x -&gt; <span style="color:#0033cc">Neg</span>(x), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Add</span>(e1, e2) -&gt; <span style="color:#990000">(* 足し算のK正規化 *)</span>
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">Add</span>(x, y), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Sub</span>(e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">Sub</span>(x, y), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">FNeg</span>(e) -&gt;
      insert_let (g env e)
        (<span style="color:green">fun</span> x -&gt; <span style="color:#0033cc">FNeg</span>(x), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">FAdd</span>(e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">FAdd</span>(x, y), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">FSub</span>(e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">FSub</span>(x, y), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">FMul</span>(e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">FMul</span>(x, y), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">FDiv</span>(e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
<a name="knormal_not"></a>            (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">FDiv</span>(x, y), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Eq</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">NEq</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Lt</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">LE</span> _ <span style="color:green">as</span> cmp -&gt;
      g env (<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(cmp, <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Bool</span>(true), <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Bool</span>(false)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Not</span>(e1), e2, e3) -&gt; g env (<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(e1, e3, e2)) <span style="color:#990000">(* notによる分岐を変換 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Eq</span>(e1, e2), e3, e4) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt;
              <span style="color:green">let</span> e3', t3 = g env e3 <span style="color:green">in</span>
              <span style="color:green">let</span> e4', t4 = g env e4 <span style="color:green">in</span>
              <span style="color:#0033cc">IfEq</span>(x, y, e3', e4'), t3))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">NEq</span>(e1, e2), e3, e4) -&gt; g env (<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Eq</span>(e1, e2), e4, e3))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Lt</span>(e1, e2), e3, e4) -&gt; g env (<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">LE</span>(e2, e1), e4, e3))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">LE</span>(e1, e2), e3, e4) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt;
<a name="knormal_if"></a>              <span style="color:green">let</span> e3', t3 = g env e3 <span style="color:green">in</span>
              <span style="color:green">let</span> e4', t4 = g env e4 <span style="color:green">in</span>
              <span style="color:#0033cc">IfLE</span>(x, y, e3', e4'), t3))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(e1, e2, e3) -&gt; g env (<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">If</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">NEq</span>(e1, <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Bool</span>(false)), e2, e3)) <span style="color:#990000">(* 比較のない分岐を変換 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt;
      <span style="color:green">let</span> e1', t1 = g env e1 <span style="color:green">in</span>
<a name="knormal_extarray"></a>      <span style="color:green">let</span> e2', t2 = g (<span style="color:#0033cc">M</span>.add x t env) e2 <span style="color:green">in</span>
      <span style="color:#0033cc">Let</span>((x, t), e1', e2'), t2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Var</span>(x) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#0033cc">Var</span>(x), <span style="color:#0033cc">M</span>.find x env
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#990000">(* 外部配列の参照 *)</span>
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x !<span style="color:#0033cc">Typing</span>.extenv <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(_) <span style="color:green">as</span> t -&gt; <span style="color:#0033cc">ExtArray</span> x, t
      <span style="color:#77aaaa">|</span> _ -&gt; failwith (<span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"external variable %s does not have an array type"</span> x))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt;
      <span style="color:green">let</span> env' =
        <span style="color:#0033cc">M</span>.add_list
          (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> fundef -&gt; fundef.<span style="color:#0033cc">Syntax</span>.name) fundefs)
          env <span style="color:green">in</span>
      <span style="color:green">let</span> e2', t2 = g env' e2 <span style="color:green">in</span>
      <span style="color:#0033cc">LetRec</span>(<span style="color:#0033cc">List</span>.map
               (<span style="color:green">fun</span> { <span style="color:#0033cc">Syntax</span>.name = xt; <span style="color:#0033cc">Syntax</span>.args = yts; <span style="color:#0033cc">Syntax</span>.body = e1 } -&gt;
                 <span style="color:green">let</span> e1', t1 = g (<span style="color:#0033cc">M</span>.add_list yts env') e1 <span style="color:green">in</span>
                 { name = xt; args = yts; body = e1' })
<a name="knormal_extfunapp"></a>               fundefs,
             e2'),
      t2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">App</span>(<span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Var</span>(f), e2s) <span style="color:#77aaaa">when</span> not (<span style="color:#0033cc">M</span>.mem f env) -&gt; <span style="color:#990000">(* 外部関数の呼び出し *)</span>
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find f !<span style="color:#0033cc">Typing</span>.extenv <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(_, t) -&gt;
          <span style="color:green">let</span> <span style="color:green">rec</span> bind xs = <span style="color:green">function</span> <span style="color:#990000">(* "xs" are identifiers for the arguments *)</span>
            <span style="color:#77aaaa">|</span> [] -&gt; <span style="color:#0033cc">ExtFunApp</span>(f, xs), t
            <span style="color:#77aaaa">|</span> e2 :: e2s -&gt;
                insert_let (g env e2)
                  (<span style="color:green">fun</span> x -&gt; bind (xs @ [x]) e2s) <span style="color:green">in</span>
          bind [] e2s <span style="color:#990000">(* left-to-right evaluation *)</span>
      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">App</span>(e1, e2s) -&gt;
      (<span style="color:#77aaaa">match</span> g env e1 <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> e1', <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(_, t) <span style="color:green">as</span> et1 -&gt;
          insert_let et1
            (<span style="color:green">fun</span> f -&gt;
              <span style="color:green">let</span> <span style="color:green">rec</span> bind xs = <span style="color:green">function</span> <span style="color:#990000">(* "xs" are identifiers for the arguments *)</span>
                <span style="color:#77aaaa">|</span> [] -&gt; <span style="color:#0033cc">App</span>(f, xs), t
                <span style="color:#77aaaa">|</span> e2 :: e2s -&gt;
                    insert_let (g env e2)
                      (<span style="color:green">fun</span> x -&gt; bind (xs @ [x]) e2s) <span style="color:green">in</span>
              bind [] e2s) <span style="color:#990000">(* left-to-right evaluation *)</span>
      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Tuple</span>(es) -&gt;
      <span style="color:green">let</span> <span style="color:green">rec</span> bind xs ts = <span style="color:green">function</span> <span style="color:#990000">(* "xs" and "ts" are identifiers and types for the elements *)</span>
        <span style="color:#77aaaa">|</span> [] -&gt; <span style="color:#0033cc">Tuple</span>(xs), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(ts)
        <span style="color:#77aaaa">|</span> e :: es -&gt;
            <span style="color:green">let</span> _, t <span style="color:green">as</span> et = g env e <span style="color:green">in</span>
            insert_let et
              (<span style="color:green">fun</span> x -&gt; bind (xs @ [x]) (ts @ [t]) es) <span style="color:green">in</span>
      bind [] [] es
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">LetTuple</span>(xts, e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> y -&gt;
          <span style="color:green">let</span> e2', t2 = g (<span style="color:#0033cc">M</span>.add_list xts env) e2 <span style="color:green">in</span>
          <span style="color:#0033cc">LetTuple</span>(xts, y, e2'), t2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Array</span>(e1, e2) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt;
          <span style="color:green">let</span> _, t2 <span style="color:green">as</span> et2 = g env e2 <span style="color:green">in</span>
          insert_let et2
            (<span style="color:green">fun</span> y -&gt;
              <span style="color:green">let</span> l =
                <span style="color:#77aaaa">match</span> t2 <span style="color:#77aaaa">with</span>
                <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; <span style="color:#aa4444">"create_float_array"</span>
                <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#aa4444">"create_array"</span> <span style="color:green">in</span>
              <span style="color:#0033cc">ExtFunApp</span>(l, [x; y]), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Get</span>(e1, e2) -&gt;
      (<span style="color:#77aaaa">match</span> g env e1 <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span>        e1', <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(t) <span style="color:green">as</span> et1 -&gt;
          insert_let et1
            (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
                (<span style="color:green">fun</span> y -&gt; <span style="color:#0033cc">Get</span>(x, y), t))
      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Syntax</span>.<span style="color:#0033cc">Put</span>(e1, e2, e3) -&gt;
      insert_let (g env e1)
        (<span style="color:green">fun</span> x -&gt; insert_let (g env e2)
            (<span style="color:green">fun</span> y -&gt; insert_let (g env e3)
                (<span style="color:green">fun</span> z -&gt; <span style="color:#0033cc">Put</span>(x, y, z), <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>)))

<span style="color:green">let</span> f e = fst (g <span style="color:#0033cc">M</span>.empty e)
</pre>

<hr>
<h1><code>alpha.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t
<span style="color:green">val</span> g : <span style="color:#0033cc">Id</span>.t <span style="color:#0033cc">M</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t <span style="color:#990000">(* for Inline.g *)</span>
</pre>

<hr>
<h1><code>alpha.ml</code></h1>

<pre><span style="color:#990000">(* rename identifiers to make them unique (alpha-conversion) *)</span>

<span style="color:#cc9900">open</span> <span style="color:#0033cc">KNormal</span>
<a name="alpha_g"></a>
<span style="color:green">let</span> find x env = <span style="color:#77aaaa">try</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; x

<span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* α変換ルーチン本体 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span>(i) -&gt; <span style="color:#0033cc">Int</span>(i)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span>(d) -&gt; <span style="color:#0033cc">Float</span>(d)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) -&gt; <span style="color:#0033cc">Neg</span>(find x env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y) -&gt; <span style="color:#0033cc">Add</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y) -&gt; <span style="color:#0033cc">Sub</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(x) -&gt; <span style="color:#0033cc">FNeg</span>(find x env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(x, y) -&gt; <span style="color:#0033cc">FAdd</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(x, y) -&gt; <span style="color:#0033cc">FSub</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(x, y) -&gt; <span style="color:#0033cc">FMul</span>(find x env, find y env)
<a name="alpha_let"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(x, y) -&gt; <span style="color:#0033cc">FDiv</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(find x env, find y env, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(find x env, find y env, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#990000">(* letのα変換 *)</span>
<a name="alpha_letrec"></a>      <span style="color:green">let</span> x' = <span style="color:#0033cc">Id</span>.genid x <span style="color:green">in</span>
      <span style="color:#0033cc">Let</span>((x', t), g env e1, g (<span style="color:#0033cc">M</span>.add x x' env) e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#0033cc">Var</span>(find x env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e) -&gt; <span style="color:#990000">(* let recのα変換 *)</span>
      <span style="color:green">let</span> gts = <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> fundef -&gt; fundef.name) fundefs <span style="color:green">in</span>
      <span style="color:green">let</span> gs = <span style="color:#0033cc">List</span>.map fst gts <span style="color:green">in</span>
      <span style="color:green">let</span> env = <span style="color:#0033cc">M</span>.add_list2 gs (<span style="color:#0033cc">List</span>.map <span style="color:#0033cc">Id</span>.genid gs) env <span style="color:green">in</span>
      <span style="color:green">let</span> fundefs =
        <span style="color:#0033cc">List</span>.map
          (<span style="color:green">fun</span> { name = (x, t); args = yts; body = e } -&gt;
            <span style="color:green">let</span> ys = <span style="color:#0033cc">List</span>.map fst yts <span style="color:green">in</span>
            <span style="color:green">let</span> env' = <span style="color:#0033cc">M</span>.add_list2 ys (<span style="color:#0033cc">List</span>.map <span style="color:#0033cc">Id</span>.genid ys) env <span style="color:green">in</span>
            { name = (find x env, t);
              args = <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> (y, t) -&gt; (find y env', t)) yts;
              body = g env' e })
          fundefs <span style="color:green">in</span>
<a name="alpha_lettuple"></a>      <span style="color:#0033cc">LetRec</span>(fundefs, g env e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span>(x, ys) -&gt; <span style="color:#0033cc">App</span>(find x env, <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; find y env) ys)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span>(xs) -&gt; <span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> x -&gt; find x env) xs)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#990000">(* LetTupleのα変換 *)</span>
      <span style="color:green">let</span> xs = <span style="color:#0033cc">List</span>.map fst xts <span style="color:green">in</span>
      <span style="color:green">let</span> env' = <span style="color:#0033cc">M</span>.add_list2 xs (<span style="color:#0033cc">List</span>.map <span style="color:#0033cc">Id</span>.genid xs) env <span style="color:green">in</span>
      <span style="color:#0033cc">LetTuple</span>(<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> (x, t) -&gt; (find x env', t)) xts,
               find y env,
               g env' e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span>(x, y) -&gt; <span style="color:#0033cc">Get</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span>(x, y, z) -&gt; <span style="color:#0033cc">Put</span>(find x env, find y env, find z env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span>(x) -&gt; <span style="color:#0033cc">ExtArray</span>(x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtFunApp</span>(x, ys) -&gt; <span style="color:#0033cc">ExtFunApp</span>(x, <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; find y env) ys)

<span style="color:green">let</span> f = g <span style="color:#0033cc">M</span>.empty
</pre>

<hr>
<h1><code>beta.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t
</pre>

<hr>
<h1><code>beta.ml</code></h1>
<a name="beta_find"></a>
<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">KNormal</span>
<a name="beta_g"></a>
<span style="color:green">let</span> find x env = <span style="color:#77aaaa">try</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; x <span style="color:#990000">(* 置換のための関数 *)</span>

<span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* β簡約ルーチン本体 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span>(i) -&gt; <span style="color:#0033cc">Int</span>(i)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span>(d) -&gt; <span style="color:#0033cc">Float</span>(d)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) -&gt; <span style="color:#0033cc">Neg</span>(find x env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y) -&gt; <span style="color:#0033cc">Add</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y) -&gt; <span style="color:#0033cc">Sub</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(x) -&gt; <span style="color:#0033cc">FNeg</span>(find x env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(x, y) -&gt; <span style="color:#0033cc">FAdd</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(x, y) -&gt; <span style="color:#0033cc">FSub</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(x, y) -&gt; <span style="color:#0033cc">FMul</span>(find x env, find y env)
<a name="beta_let"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(x, y) -&gt; <span style="color:#0033cc">FDiv</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(find x env, find y env, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(find x env, find y env, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#990000">(* letのβ簡約 *)</span>
      (<span style="color:#77aaaa">match</span> g env e1 <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(y) -&gt;
          <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"beta-reducing %s = %s@."</span> x y;
          g (<span style="color:#0033cc">M</span>.add x y env) e2
      <span style="color:#77aaaa">|</span> e1' -&gt;
          <span style="color:green">let</span> e2' = g env e2 <span style="color:green">in</span>
          <span style="color:#0033cc">Let</span>((x, t), e1', e2'))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e) -&gt;
      <span style="color:green">let</span> fundefs =
        <span style="color:#0033cc">List</span>.map
          (<span style="color:green">fun</span> { name = xt; args = yts; body = e } -&gt;
<a name="beta_var"></a>            { name = xt; args = yts; body = g env e })
          fundefs <span style="color:green">in</span>
      <span style="color:#0033cc">LetRec</span>(fundefs, g env e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#0033cc">Var</span>(find x env) <span style="color:#990000">(* 変数を置換 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span>(xs) -&gt; <span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> x -&gt; find x env) xs)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#0033cc">LetTuple</span>(xts, find y env, g env e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span>(x, y) -&gt; <span style="color:#0033cc">Get</span>(find x env, find y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span>(x, y, z) -&gt; <span style="color:#0033cc">Put</span>(find x env, find y env, find z env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span>(g, xs) -&gt; <span style="color:#0033cc">App</span>(find g env, <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> x -&gt; find x env) xs)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span>(x) -&gt; <span style="color:#0033cc">ExtArray</span>(x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtFunApp</span>(x, ys) -&gt; <span style="color:#0033cc">ExtFunApp</span>(x, <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; find y env) ys)

<span style="color:green">let</span> f = g <span style="color:#0033cc">M</span>.empty
</pre>

<hr>
<h1><code>assoc.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t
</pre>

<hr>
<h1><code>assoc.ml</code></h1>

<pre><span style="color:#990000">(* flatten let-bindings (just for prettier printing) *)</span>
<a name="assoc_f"></a>
<span style="color:#cc9900">open</span> <span style="color:#0033cc">KNormal</span>

<a name="assoc_let"></a><span style="color:green">let</span> <span style="color:green">rec</span> f = <span style="color:green">function</span> <span style="color:#990000">(* ネストしたletの簡約 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(x, y, f e1, f e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(x, y, f e1, f e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(xt, e1, e2) -&gt; <span style="color:#990000">(* letの場合 *)</span>
      <span style="color:green">let</span> <span style="color:green">rec</span> insert = <span style="color:green">function</span>
        <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(yt, e3, e4) -&gt; <span style="color:#0033cc">Let</span>(yt, e3, insert e4)
        <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e) -&gt; <span style="color:#0033cc">LetRec</span>(fundefs, insert e)
        <span style="color:#77aaaa">|</span> e -&gt; <span style="color:#0033cc">Let</span>(xt, e, f e2) <span style="color:green">in</span>
      insert (f e1)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt;
      <span style="color:#0033cc">LetRec</span>(<span style="color:#0033cc">List</span>.map
               (<span style="color:green">fun</span> { name = xt; args = yts; body = e1 } -&gt;
                 { name = xt; args = yts; body = f e1 })
               fundefs,
             f e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#0033cc">LetTuple</span>(xts, y, f e)
  <span style="color:#77aaaa">|</span> e -&gt; e
</pre>

<hr>
<h1><code>inline.mli</code></h1>

<pre><span style="color:green">val</span> threshold : int ref
<span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t
</pre>

<hr>
<h1><code>inline.ml</code></h1>
<a name="inline_threshold"></a>
<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">KNormal</span>

<span style="color:#990000">(* インライン展開する関数の最大サイズ *)</span>
<span style="color:green">let</span> threshold = ref 0 <span style="color:#990000">(* Mainで-inlineオプションによりセットされる *)</span>

<span style="color:green">let</span> <span style="color:green">rec</span> size = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(_, _, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(_, _, e1, e2) -&gt; 1 + size e1 + size e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(_, e1, e2) -&gt; 1 + size e1 + size e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt;
      <span style="color:#0033cc">List</span>.fold_left
        (<span style="color:green">fun</span> s { body = e1 } -&gt; s + 1 + size e1)
        (size e2)
        fundefs
<a name="inline_g"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(_, _, e) -&gt; 1 + size e
  <span style="color:#77aaaa">|</span> _ -&gt; 1

<span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* インライン展開ルーチン本体 *)</span>
<a name="inline_letrec"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(x, y, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(x, y, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(xt, e1, e2) -&gt; <span style="color:#0033cc">Let</span>(xt, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt; <span style="color:#990000">(* 関数定義の場合 *)</span>
      <span style="color:green">let</span> env =
        <span style="color:#0033cc">List</span>.fold_left
          (<span style="color:green">fun</span> env { name = (x, t); args = yts; body = e1 } -&gt;
            <span style="color:#77aaaa">if</span> size e1 &gt; !threshold <span style="color:#77aaaa">then</span> env <span style="color:#77aaaa">else</span> <span style="color:#0033cc">M</span>.add x (yts, e1) env)
          env
          fundefs <span style="color:green">in</span>
      <span style="color:green">let</span> fundefs' =
        <span style="color:#0033cc">List</span>.map
          (<span style="color:green">fun</span> { name = xt; args = yts; body = e1 } -&gt;
<a name="inline_app"></a>            { name = xt; args = yts; body = g env e1})
          fundefs <span style="color:green">in</span>
      <span style="color:#0033cc">LetRec</span>(fundefs', g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span>(x, ys) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#990000">(* 関数適用の場合 *)</span>
      <span style="color:green">let</span> (args, body) = <span style="color:#0033cc">M</span>.find x env <span style="color:green">in</span>
      <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"inlining %s@."</span> x;
      <span style="color:green">let</span> env =
        <span style="color:#0033cc">List</span>.fold_left2
          (<span style="color:green">fun</span> env (z, t) y -&gt; <span style="color:#0033cc">M</span>.add z y env)
          <span style="color:#0033cc">M</span>.empty
          args
          ys <span style="color:green">in</span>
      <span style="color:#0033cc">Alpha</span>.g env body
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#0033cc">LetTuple</span>(xts, y, g env e)
  <span style="color:#77aaaa">|</span> e -&gt; e

<span style="color:green">let</span> f e = g <span style="color:#0033cc">M</span>.empty e
</pre>

<hr>
<h1><code>constFold.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t
</pre>

<hr>
<h1><code>constFold.ml</code></h1>

<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">KNormal</span>

<span style="color:green">let</span> memi x env =
  <span style="color:#77aaaa">try</span> (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Int</span>(_) -&gt; true <span style="color:#77aaaa">|</span> _ -&gt; false)
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; false
<span style="color:green">let</span> memf x env =
  <span style="color:#77aaaa">try</span> (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Float</span>(_) -&gt; true <span style="color:#77aaaa">|</span> _ -&gt; false)
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; false
<span style="color:green">let</span> memt x env =
  <span style="color:#77aaaa">try</span> (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Tuple</span>(_) -&gt; true <span style="color:#77aaaa">|</span> _ -&gt; false)
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; false

<span style="color:green">let</span> findi x env = (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Int</span>(i) -&gt; i <span style="color:#77aaaa">|</span> _ -&gt; raise <span style="color:#0033cc">Not_found</span>)
<a name="constfold_g"></a><span style="color:green">let</span> findf x env = (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Float</span>(d) -&gt; d <span style="color:#77aaaa">|</span> _ -&gt; raise <span style="color:#0033cc">Not_found</span>)
<span style="color:green">let</span> findt x env = (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Tuple</span>(ys) -&gt; ys <span style="color:#77aaaa">|</span> _ -&gt; raise <span style="color:#0033cc">Not_found</span>)

<a name="constfold_add"></a><span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* 定数畳み込みルーチン本体 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) <span style="color:#77aaaa">when</span> memi x env -&gt; <span style="color:#0033cc">Int</span>(findi x env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) <span style="color:#77aaaa">when</span> memi x env -&gt; <span style="color:#0033cc">Int</span>(-(findi x env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y) <span style="color:#77aaaa">when</span> memi x env &amp;&amp; memi y env -&gt; <span style="color:#0033cc">Int</span>(findi x env + findi y env) <span style="color:#990000">(* 足し算のケース *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y) <span style="color:#77aaaa">when</span> memi x env &amp;&amp; memi y env -&gt; <span style="color:#0033cc">Int</span>(findi x env - findi y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(x) <span style="color:#77aaaa">when</span> memf x env -&gt; <span style="color:#0033cc">Float</span>(-.(findf x env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(x, y) <span style="color:#77aaaa">when</span> memf x env &amp;&amp; memf y env -&gt; <span style="color:#0033cc">Float</span>(findf x env +. findf y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(x, y) <span style="color:#77aaaa">when</span> memf x env &amp;&amp; memf y env -&gt; <span style="color:#0033cc">Float</span>(findf x env -. findf y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(x, y) <span style="color:#77aaaa">when</span> memf x env &amp;&amp; memf y env -&gt; <span style="color:#0033cc">Float</span>(findf x env *. findf y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(x, y) <span style="color:#77aaaa">when</span> memf x env &amp;&amp; memf y env -&gt; <span style="color:#0033cc">Float</span>(findf x env /. findf y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) <span style="color:#77aaaa">when</span> memi x env &amp;&amp; memi y env -&gt; <span style="color:#77aaaa">if</span> findi x env = findi y env <span style="color:#77aaaa">then</span> g env e1 <span style="color:#77aaaa">else</span> g env e2
<a name="constfold_let"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(x, y, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) <span style="color:#77aaaa">when</span> memi x env &amp;&amp; memi y env -&gt; <span style="color:#77aaaa">if</span> findi x env &lt;= findi y env <span style="color:#77aaaa">then</span> g env e1 <span style="color:#77aaaa">else</span> g env e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(x, y, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#990000">(* letのケース *)</span>
      <span style="color:green">let</span> e1' = g env e1 <span style="color:green">in</span>
      <span style="color:green">let</span> e2' = g (<span style="color:#0033cc">M</span>.add x e1' env) e2 <span style="color:green">in</span>
      <span style="color:#0033cc">Let</span>((x, t), e1', e2')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(bindings, e2) -&gt;
      <span style="color:#0033cc">LetRec</span>(<span style="color:#0033cc">List</span>.map
               (<span style="color:green">fun</span> { name = x; args = ys; body = e1 } -&gt;
                 { name = x; args = ys; body = g env e1 })
               bindings,
             g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) <span style="color:#77aaaa">when</span> memt y env -&gt;
      <span style="color:#0033cc">List</span>.fold_left2
        (<span style="color:green">fun</span> e' xt z -&gt; <span style="color:#0033cc">Let</span>(xt, <span style="color:#0033cc">Var</span>(z), e'))
        (g env e)
        xts
        (findt y env)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#0033cc">LetTuple</span>(xts, y, g env e)
  <span style="color:#77aaaa">|</span> e -&gt; e

<span style="color:green">let</span> f = g <span style="color:#0033cc">M</span>.empty
</pre>

<hr>
<h1><code>elim.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; <span style="color:#0033cc">KNormal</span>.t
</pre>

<hr>
<h1><code>elim.ml</code></h1>
<a name="elim_effect"></a>
<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">KNormal</span>

<span style="color:green">let</span> <span style="color:green">rec</span> effect = <span style="color:green">function</span> <span style="color:#990000">(* 副作用の有無 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(_, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(_, _, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(_, _, e1, e2) -&gt; effect e1 || effect e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(_, e) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(_, _, e) -&gt; effect e
<a name="elim_f"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">App</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtFunApp</span> _ -&gt; true
  <span style="color:#77aaaa">|</span> _ -&gt; false

<a name="elim_let"></a><span style="color:green">let</span> <span style="color:green">rec</span> f = <span style="color:green">function</span> <span style="color:#990000">(* 不要定義削除ルーチン本体 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(x, y, f e1, f e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(x, y, f e1, f e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#990000">(* letの場合 *)</span>
      <span style="color:green">let</span> e1' = f e1 <span style="color:green">in</span>
      <span style="color:green">let</span> e2' = f e2 <span style="color:green">in</span>
      <span style="color:green">let</span> live = fv e2' <span style="color:green">in</span>
<a name="elim_letrec"></a>      <span style="color:#77aaaa">if</span> effect e1' || <span style="color:#0033cc">S</span>.mem x live <span style="color:#77aaaa">then</span> <span style="color:#0033cc">Let</span>((x, t), e1', e2') <span style="color:#77aaaa">else</span>
      (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"eliminating variable %s@."</span> x;
       e2')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt; <span style="color:#990000">(* let recの場合 *)</span>
      <span style="color:green">let</span> fundefs' =
        <span style="color:#0033cc">List</span>.map
          (<span style="color:green">fun</span> { name = xt; args = yts; body = e } -&gt;
            { name = xt; args = yts; body = f e })
          fundefs <span style="color:green">in</span>
      <span style="color:green">let</span> e2' = f e2 <span style="color:green">in</span>
      <span style="color:green">let</span> live = fv e2' <span style="color:green">in</span>
      <span style="color:green">let</span> xts = <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> fundef -&gt; fundef.name) fundefs' <span style="color:green">in</span>
      <span style="color:green">let</span> xs = <span style="color:#0033cc">List</span>.map fst xts <span style="color:green">in</span>
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.exists (<span style="color:green">fun</span> x -&gt; <span style="color:#0033cc">S</span>.mem x live) xs <span style="color:#77aaaa">then</span> <span style="color:#0033cc">LetRec</span>(fundefs', e2') <span style="color:#77aaaa">else</span>
      (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"eliminating function(s) %s@."</span> (<span style="color:#0033cc">Id</span>.pp_list xs);
       e2')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt;
      <span style="color:green">let</span> xs = <span style="color:#0033cc">List</span>.map fst xts <span style="color:green">in</span>
      <span style="color:green">let</span> e' = f e <span style="color:green">in</span>
      <span style="color:green">let</span> live = fv e' <span style="color:green">in</span>
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.exists (<span style="color:green">fun</span> x -&gt; <span style="color:#0033cc">S</span>.mem x live) xs <span style="color:#77aaaa">then</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e') <span style="color:#77aaaa">else</span>
      (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"eliminating variables %s@."</span> (<span style="color:#0033cc">Id</span>.pp_list xs);
       e')
  <span style="color:#77aaaa">|</span> e -&gt; e
</pre>

<hr>
<h1><code>closure.mli</code></h1>

<pre><span style="color:green">type</span> closure = { entry : <span style="color:#0033cc">Id</span>.l; actual_fv : <span style="color:#0033cc">Id</span>.t list }
<span style="color:green">type</span> t =
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span> <span style="color:green">of</span> float
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">MakeCls</span> <span style="color:green">of</span> ((<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * closure) list * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">AppCls</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">AppDir</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list * <span style="color:#0033cc">Id</span>.t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l
<span style="color:green">type</span> fundef = { name : <span style="color:#0033cc">Id</span>.l * <span style="color:#0033cc">Type</span>.t;
                args : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list;
                formal_fv : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list;
                body : t }
<span style="color:green">type</span> prog = <span style="color:#0033cc">Prog</span> <span style="color:green">of</span> fundef list * t

<span style="color:green">val</span> fv : t -&gt; <span style="color:#0033cc">S</span>.t
<span style="color:green">val</span> f : <span style="color:#0033cc">KNormal</span>.t -&gt; prog
</pre>

<hr>
<a name="closure_t"></a><h1><code>closure.ml</code></h1>

<pre><span style="color:green">type</span> closure = { entry : <span style="color:#0033cc">Id</span>.l; actual_fv : <span style="color:#0033cc">Id</span>.t list }
<span style="color:green">type</span> t = <span style="color:#990000">(* クロージャ変換後の式 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span> <span style="color:green">of</span> float
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">MakeCls</span> <span style="color:green">of</span> ((<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * closure) list * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">AppCls</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">AppDir</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list * <span style="color:#0033cc">Id</span>.t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l
<span style="color:green">type</span> fundef = { name : <span style="color:#0033cc">Id</span>.l * <span style="color:#0033cc">Type</span>.t;
                args : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list;
                formal_fv : (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) list;
                body : t }
<span style="color:green">type</span> prog = <span style="color:#0033cc">Prog</span> <span style="color:green">of</span> fundef list * t

<span style="color:green">let</span> <span style="color:green">rec</span> fv = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Unit</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Int</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Float</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ExtArray</span>(_) -&gt; <span style="color:#0033cc">S</span>.empty
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNeg</span>(x) -&gt; <span style="color:#0033cc">S</span>.singleton x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAdd</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSub</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMul</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDiv</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Get</span>(x, y) -&gt; <span style="color:#0033cc">S</span>.of_list [x; y]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y, e1, e2)<span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">S</span>.add x (<span style="color:#0033cc">S</span>.add y (<span style="color:#0033cc">S</span>.union (fv e1) (fv e2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#0033cc">S</span>.union (fv e1) (<span style="color:#0033cc">S</span>.remove x (fv e2))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#0033cc">S</span>.singleton x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">MakeCls</span>(bindings, e) -&gt;
      <span style="color:green">let</span> (xs, yss) =
        <span style="color:#0033cc">List</span>.fold_left
          (<span style="color:green">fun</span> (xs, yss) ((x, t), { entry = l; actual_fv = ys }) -&gt;
            (<span style="color:#0033cc">S</span>.add x xs, <span style="color:#0033cc">S</span>.union yss (<span style="color:#0033cc">S</span>.of_list ys)))
          (<span style="color:#0033cc">S</span>.empty, <span style="color:#0033cc">S</span>.empty)
          bindings <span style="color:green">in</span>
      <span style="color:#0033cc">S</span>.diff (<span style="color:#0033cc">S</span>.union yss (fv e)) xs
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">AppCls</span>(x, ys) -&gt; <span style="color:#0033cc">S</span>.of_list (x :: ys)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">AppDir</span>(_, xs) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tuple</span>(xs) -&gt; <span style="color:#0033cc">S</span>.of_list xs
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#0033cc">S</span>.add y (<span style="color:#0033cc">S</span>.diff (fv e) (<span style="color:#0033cc">S</span>.of_list (<span style="color:#0033cc">List</span>.map fst xts)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Put</span>(x, y, z) -&gt; <span style="color:#0033cc">S</span>.of_list [x; y; z]
<a name="closure_g"></a>
<span style="color:green">let</span> toplevel : fundef list ref = ref []

<span style="color:green">let</span> <span style="color:green">rec</span> g env known = <span style="color:green">function</span> <span style="color:#990000">(* クロージャ変換ルーチン本体 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Unit</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Int</span>(i) -&gt; <span style="color:#0033cc">Int</span>(i)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Float</span>(d) -&gt; <span style="color:#0033cc">Float</span>(d)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Neg</span>(x) -&gt; <span style="color:#0033cc">Neg</span>(x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Add</span>(x, y) -&gt; <span style="color:#0033cc">Add</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Sub</span>(x, y) -&gt; <span style="color:#0033cc">Sub</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">FNeg</span>(x) -&gt; <span style="color:#0033cc">FNeg</span>(x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">FAdd</span>(x, y) -&gt; <span style="color:#0033cc">FAdd</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">FSub</span>(x, y) -&gt; <span style="color:#0033cc">FSub</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">FMul</span>(x, y) -&gt; <span style="color:#0033cc">FMul</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">FDiv</span>(x, y) -&gt; <span style="color:#0033cc">FDiv</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(x, y, g env known e1, g env known e2)
<a name="closure_letrec"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(x, y, g env known e1, g env known e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Let</span>((x, t), e1, e2) -&gt; <span style="color:#0033cc">Let</span>((x, t), g env known e1, g (<span style="color:#0033cc">M</span>.add x t env) known e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Var</span>(x) -&gt; <span style="color:#0033cc">Var</span>(x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">LetRec</span>(fundefs, e2) -&gt; <span style="color:#990000">(* 関数定義の場合 *)</span>
      <span style="color:#990000">(* 関数定義let rec x y1 ... yn = e1 in e2の場合は、</span>
<span style="color:#990000"></span>        <span style="color:#990000"> xに自由変数がない(closureを介さずdirectに呼び出せる)</span>
<span style="color:#990000"></span>        <span style="color:#990000"> と仮定し、knownに追加してe1をクロージャ変換してみる *)</span>
      <span style="color:green">let</span> toplevel_back = !toplevel <span style="color:green">in</span>
      <span style="color:green">let</span> xts = <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> { <span style="color:#0033cc">KNormal</span>.name = xt } -&gt; xt) fundefs <span style="color:green">in</span>
      <span style="color:green">let</span> xs = <span style="color:#0033cc">List</span>.map fst xts <span style="color:green">in</span>
      <span style="color:green">let</span> env' = <span style="color:#0033cc">M</span>.add_list xts env <span style="color:green">in</span>
      <span style="color:green">let</span> known' = <span style="color:#0033cc">S</span>.union known (<span style="color:#0033cc">S</span>.of_list xs) <span style="color:green">in</span>
      <span style="color:green">let</span> e1s' =
        <span style="color:#0033cc">List</span>.map
          (<span style="color:green">fun</span> { <span style="color:#0033cc">KNormal</span>.args = yts; <span style="color:#0033cc">KNormal</span>.body = e1 } -&gt;
            g (<span style="color:#0033cc">M</span>.add_list yts env') known' e1)
          fundefs <span style="color:green">in</span>
      <span style="color:#990000">(* 本当に自由変数がなかったか、変換結果e1'を確認する *)</span>
      <span style="color:green">let</span> check =
        <span style="color:#0033cc">List</span>.fold_left2
          (<span style="color:green">fun</span> check { <span style="color:#0033cc">KNormal</span>.name = (x, t); <span style="color:#0033cc">KNormal</span>.args = yts } e1' -&gt;
            check &amp;&amp;
            <span style="color:#990000">(* x自身と引数y1,...,yn以外は自由変数とみなす(相互再帰関数も) *)</span>
            <span style="color:green">let</span> fv = <span style="color:#0033cc">S</span>.diff (fv e1') (<span style="color:#0033cc">S</span>.add x (<span style="color:#0033cc">S</span>.of_list (<span style="color:#0033cc">List</span>.map fst yts))) <span style="color:green">in</span>
            <span style="color:#77aaaa">if</span> <span style="color:#0033cc">S</span>.is_empty fv <span style="color:#77aaaa">then</span> true <span style="color:#77aaaa">else</span>
            (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"free variable(s) %s found in function %s@."</span> (<span style="color:#0033cc">Id</span>.pp_list (<span style="color:#0033cc">S</span>.elements fv)) x;
             false))
          true
          fundefs
          e1s' <span style="color:green">in</span>
      <span style="color:green">let</span> known', e1s' =
        <span style="color:#77aaaa">if</span> check <span style="color:#77aaaa">then</span> known', e1s' <span style="color:#77aaaa">else</span>
        <span style="color:#990000">(* 駄目だったら状態(toplevelの値)を戻して、クロージャ変換をやり直す *)</span>
        (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"function(s) %s cannot be directly applied in fact@."</span> (<span style="color:#0033cc">Id</span>.pp_list xs);
         toplevel := toplevel_back;
         <span style="color:green">let</span> e1s' =
           <span style="color:#0033cc">List</span>.map
             (<span style="color:green">fun</span> { <span style="color:#0033cc">KNormal</span>.args = yts; <span style="color:#0033cc">KNormal</span>.body = e1 } -&gt;
               g (<span style="color:#0033cc">M</span>.add_list yts env') known e1)
             fundefs <span style="color:green">in</span>
         known, e1s') <span style="color:green">in</span>
      <span style="color:green">let</span> bindings =
        <span style="color:#0033cc">List</span>.map2
          (<span style="color:green">fun</span> { <span style="color:#0033cc">KNormal</span>.name = (x, t); <span style="color:#0033cc">KNormal</span>.args = yts; <span style="color:#0033cc">KNormal</span>.body = e1 } e1' -&gt;
            <span style="color:green">let</span> zs = <span style="color:#0033cc">S</span>.elements (<span style="color:#0033cc">S</span>.remove x (<span style="color:#0033cc">S</span>.diff (fv e1') (<span style="color:#0033cc">S</span>.of_list (<span style="color:#0033cc">List</span>.map fst yts)))) <span style="color:green">in</span> <span style="color:#990000">(* 自由変数のリスト *)</span>
            <span style="color:green">let</span> zts = <span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> z -&gt; (z, <span style="color:#0033cc">M</span>.find z env')) zs <span style="color:green">in</span> <span style="color:#990000">(* ここで自由変数zの型を引くために引数envが必要 *)</span>
            toplevel := { name = (<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), t); args = yts; formal_fv = zts; body = e1' } :: !toplevel; <span style="color:#990000">(* トップレベル関数を追加 *)</span>
            ((x, t), { entry = <span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x); actual_fv = zs })) <span style="color:#990000">(* MakeClsのための束縛 *)</span>
          fundefs
          e1s' <span style="color:green">in</span>
      <span style="color:green">let</span> e2' = g env' known' e2 <span style="color:green">in</span>
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">S</span>.is_empty (<span style="color:#0033cc">S</span>.inter (<span style="color:#0033cc">S</span>.of_list xs) (fv e2')) <span style="color:#77aaaa">then</span> <span style="color:#990000">(* xが変数としてe2'に出現するか *)</span>
<a name="closure_app"></a>        (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"eliminating closure(s) %s@."</span> (<span style="color:#0033cc">Id</span>.pp_list xs);
         e2') <span style="color:#990000">(* 出現しなければMakeClsを削除 *)</span>
      <span style="color:#77aaaa">else</span> <span style="color:#0033cc">MakeCls</span>(bindings, e2') <span style="color:#990000">(* 出現していたら削除しない *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">App</span>(x, ys) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">S</span>.mem x known -&gt; <span style="color:#990000">(* 関数適用の場合 *)</span>
      <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"directly applying %s@."</span> x;
      <span style="color:#0033cc">AppDir</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), ys)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">App</span>(f, xs) -&gt; <span style="color:#0033cc">AppCls</span>(f, xs)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Tuple</span>(xs) -&gt; <span style="color:#0033cc">Tuple</span>(xs)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">LetTuple</span>(xts, y, e) -&gt; <span style="color:#0033cc">LetTuple</span>(xts, y, g (<span style="color:#0033cc">M</span>.add_list xts env) known e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Get</span>(x, y) -&gt; <span style="color:#0033cc">Get</span>(x, y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">Put</span>(x, y, z) -&gt; <span style="color:#0033cc">Put</span>(x, y, z)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">ExtArray</span>(x) -&gt; <span style="color:#0033cc">ExtArray</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">KNormal</span>.<span style="color:#0033cc">ExtFunApp</span>(x, ys) -&gt; <span style="color:#0033cc">AppDir</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(<span style="color:#aa4444">"min_caml_"</span> ^ x), ys)

<span style="color:green">let</span> f e =
  toplevel := [];
  <span style="color:green">let</span> e' = g <span style="color:#0033cc">M</span>.empty <span style="color:#0033cc">S</span>.empty e <span style="color:green">in</span>
  <span style="color:#0033cc">Prog</span>(<span style="color:#0033cc">List</span>.rev !toplevel, e')
</pre>

<hr>
<h1><code>sparcAsm.mli</code></h1>

<pre><span style="color:green">type</span> id_or_imm = <span style="color:#0033cc">V</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#77aaaa">|</span> <span style="color:#0033cc">C</span> <span style="color:green">of</span> int
<span style="color:green">type</span> t =
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span> <span style="color:green">of</span> exp
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * exp * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * t <span style="color:#990000">(* virtual instruction *)</span>
<span style="color:green">and</span> exp =
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Nop</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Set</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SetL</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Mov</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SLL</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ld</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">St</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMovD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNegD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAddD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSubD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMulD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDivD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LdDF</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">StDF</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Comment</span> <span style="color:green">of</span> string
  <span style="color:#990000">(* virtual instructions *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#990000">(* closure address, integer arguments, and float arguments *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallCls</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallDir</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l * <span style="color:#0033cc">Id</span>.t list * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Save</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* レジスタ変数の値をスタック変数へ保存 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Restore</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* スタック変数から値を復元 *)</span>
<span style="color:green">type</span> fundef = { name : <span style="color:#0033cc">Id</span>.l; args : <span style="color:#0033cc">Id</span>.t list; fargs : <span style="color:#0033cc">Id</span>.t list; body : t; ret : <span style="color:#0033cc">Type</span>.t }
<span style="color:green">type</span> prog = <span style="color:#0033cc">Prog</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.l * float) list * fundef list * t

<span style="color:green">val</span> fletd : <span style="color:#0033cc">Id</span>.t * exp * t -&gt; t <span style="color:#990000">(* shorthand of Let for float *)</span>
<span style="color:green">val</span> seq : exp * t -&gt; t <span style="color:#990000">(* shorthand of Let for unit *)</span>

<span style="color:green">val</span> regs : <span style="color:#0033cc">Id</span>.t array
<span style="color:green">val</span> fregs : <span style="color:#0033cc">Id</span>.t array
<span style="color:green">val</span> allregs : <span style="color:#0033cc">Id</span>.t list
<span style="color:green">val</span> allfregs : <span style="color:#0033cc">Id</span>.t list
<span style="color:green">val</span> reg_cl : <span style="color:#0033cc">Id</span>.t
<span style="color:green">val</span> reg_sw : <span style="color:#0033cc">Id</span>.t
<span style="color:green">val</span> reg_fsw : <span style="color:#0033cc">Id</span>.t
<span style="color:green">val</span> reg_ra : <span style="color:#0033cc">Id</span>.t
<span style="color:green">val</span> reg_hp : <span style="color:#0033cc">Id</span>.t
<span style="color:green">val</span> reg_sp : <span style="color:#0033cc">Id</span>.t
<span style="color:green">val</span> is_reg : <span style="color:#0033cc">Id</span>.t -&gt; bool
<span style="color:green">val</span> co_freg : <span style="color:#0033cc">Id</span>.t -&gt; <span style="color:#0033cc">Id</span>.t

<span style="color:green">val</span> fv : t -&gt; <span style="color:#0033cc">Id</span>.t list
<span style="color:green">val</span> concat : t -&gt; <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t -&gt; t -&gt; t

<span style="color:green">val</span> align : int -&gt; int
</pre>

<hr>
<h1><code>sparcAsm.ml</code></h1>

<a name="sparcasm_t"></a><pre><span style="color:#990000">(* SPARC assembly with a few virtual instructions *)</span>

<span style="color:green">type</span> id_or_imm = <span style="color:#0033cc">V</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#77aaaa">|</span> <span style="color:#0033cc">C</span> <span style="color:green">of</span> int
<a name="sparcasm_forget"></a><span style="color:green">type</span> t = <span style="color:#990000">(* 命令の列 *)</span>
<a name="sparcasm_exp"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span> <span style="color:green">of</span> exp
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t) * exp * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * t <span style="color:#990000">(* Spillされた変数を、自由変数の計算から除外するための仮想命令 *)</span>
<span style="color:green">and</span> exp = <span style="color:#990000">(* 一つ一つの命令に対応する式 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Nop</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Set</span> <span style="color:green">of</span> int
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SetL</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Mov</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SLL</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ld</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">St</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMovD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNegD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAddD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSubD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMulD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDivD</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LdDF</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">StDF</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * id_or_imm
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Comment</span> <span style="color:green">of</span> string
  <span style="color:#990000">(* virtual instructions *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * id_or_imm * t * t <span style="color:#990000">(* 左右対称ではないので必要 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFEq</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFLE</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t * t * t
<a name="sparcasm_save"></a>  <span style="color:#990000">(* closure address, integer arguments, and float arguments *)</span>
<a name="sparcasm_restore"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallCls</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t list * <span style="color:#0033cc">Id</span>.t list
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallDir</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.l * <span style="color:#0033cc">Id</span>.t list * <span style="color:#0033cc">Id</span>.t list
<a name="sparcasm_prog"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Save</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* レジスタ変数の値をスタック変数へ保存 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Restore</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* スタック変数から値を復元 *)</span>
<span style="color:green">type</span> fundef = { name : <span style="color:#0033cc">Id</span>.l; args : <span style="color:#0033cc">Id</span>.t list; fargs : <span style="color:#0033cc">Id</span>.t list; body : t; ret : <span style="color:#0033cc">Type</span>.t }
<span style="color:#990000">(* プログラム全体 = 浮動小数定数テーブル + トップレベル関数 + メインの式 *)</span>
<span style="color:green">type</span> prog = <span style="color:#0033cc">Prog</span> <span style="color:green">of</span> (<span style="color:#0033cc">Id</span>.l * float) list * fundef list * t

<span style="color:green">let</span> fletd(x, e1, e2) = <span style="color:#0033cc">Let</span>((x, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>), e1, e2)
<span style="color:green">let</span> seq(e1, e2) = <span style="color:#0033cc">Let</span>((<span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>), e1, e2)

<span style="color:green">let</span> regs = <span style="color:#990000">(* Array.init 16 (fun i -&gt; Printf.sprintf "%%r%d" i) *)</span>
  [| <span style="color:#aa4444">"%i2"</span>; <span style="color:#aa4444">"%i3"</span>; <span style="color:#aa4444">"%i4"</span>; <span style="color:#aa4444">"%i5"</span>;
     <span style="color:#aa4444">"%l0"</span>; <span style="color:#aa4444">"%l1"</span>; <span style="color:#aa4444">"%l2"</span>; <span style="color:#aa4444">"%l3"</span>; <span style="color:#aa4444">"%l4"</span>; <span style="color:#aa4444">"%l5"</span>; <span style="color:#aa4444">"%l6"</span>; <span style="color:#aa4444">"%l7"</span>;
     <span style="color:#aa4444">"%o0"</span>; <span style="color:#aa4444">"%o1"</span>; <span style="color:#aa4444">"%o2"</span>; <span style="color:#aa4444">"%o3"</span>; <span style="color:#aa4444">"%o4"</span>; <span style="color:#aa4444">"%o5"</span> |]
<a name="sparcasm_regcl"></a><span style="color:green">let</span> fregs = <span style="color:#0033cc">Array</span>.init 8 (<span style="color:green">fun</span> i -&gt; <span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"%%f%d"</span> (i * 2))
<span style="color:green">let</span> allregs = <span style="color:#0033cc">List</span>.rev (<span style="color:#0033cc">Array</span>.to_list regs)
<span style="color:green">let</span> allfregs = <span style="color:#0033cc">List</span>.rev (<span style="color:#0033cc">Array</span>.to_list fregs)
<span style="color:green">let</span> reg_cl = regs.(<span style="color:#0033cc">Array</span>.length regs - 1) <span style="color:#990000">(* closure address *)</span>
<a name="sparcasm_reghp"></a><span style="color:green">let</span> reg_sw = regs.(<span style="color:#0033cc">Array</span>.length regs - 2) <span style="color:#990000">(* temporary for swap *)</span>
<span style="color:green">let</span> reg_fsw = fregs.(<span style="color:#0033cc">Array</span>.length fregs - 1) <span style="color:#990000">(* temporary for swap *)</span>
<span style="color:green">let</span> reg_sp = <span style="color:#aa4444">"%i0"</span> <span style="color:#990000">(* stack pointer *)</span>
<span style="color:green">let</span> reg_hp = <span style="color:#aa4444">"%i1"</span> <span style="color:#990000">(* heap pointer *)</span>
<span style="color:green">let</span> reg_ra = <span style="color:#aa4444">"%o7"</span> <span style="color:#990000">(* return address *)</span>
<span style="color:green">let</span> is_reg x = (x.[0] = <span style="color:#aa4444">'%'</span>)
<span style="color:green">let</span> co_freg_table =
  <span style="color:green">let</span> ht = <span style="color:#0033cc">Hashtbl</span>.create 8 <span style="color:green">in</span>
  <span style="color:#77aaaa">for</span> i = 0 <span style="color:#77aaaa">to</span> 7 <span style="color:#77aaaa">do</span>
    <span style="color:#0033cc">Hashtbl</span>.add
      ht
      (<span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"%%f%d"</span> (i * 2))
      (<span style="color:#0033cc">Printf</span>.sprintf <span style="color:#aa4444">"%%f%d"</span> (i * 2 + 1))
  <span style="color:#77aaaa">done</span>;
  ht
<span style="color:green">let</span> co_freg freg = <span style="color:#0033cc">Hashtbl</span>.find co_freg_table freg <span style="color:#990000">(* "companion" freg *)</span>

<span style="color:#990000">(* super-tenuki *)</span>
<span style="color:green">let</span> remove x ys = <span style="color:#0033cc">List</span>.filter (<span style="color:green">fun</span> y -&gt; y &lt;&gt; x) ys
<span style="color:green">let</span> remove_list xs ys = <span style="color:#0033cc">List</span>.filter (<span style="color:green">fun</span> y -&gt; not (<span style="color:#0033cc">List</span>.mem y xs)) ys
<a name="sparcasm_fv"></a><span style="color:green">let</span> add x ys = x :: remove x ys
<span style="color:green">let</span> add_list xs ys = xs @ remove_list xs ys

<span style="color:#990000">(* free variables in the order of use (for spilling) *)</span>
<span style="color:green">let</span> fv_id_or_imm = <span style="color:green">function</span> <span style="color:#0033cc">V</span>(x) -&gt; [x] <span style="color:#77aaaa">|</span> _ -&gt; []
<span style="color:green">let</span> <span style="color:green">rec</span> fv_exp = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Nop</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Set</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SetL</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Comment</span>(_) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Restore</span>(_) -&gt; []
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Mov</span>(x) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMovD</span>(x) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNegD</span>(x) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Save</span>(x, _) -&gt; [x]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y') <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y') <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SLL</span>(x, y') <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ld</span>(x, y') <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LdDF</span>(x, y') -&gt; add x (fv_id_or_imm y')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">St</span>(x, y, z') <span style="color:#77aaaa">|</span> <span style="color:#0033cc">StDF</span>(x, y, z') -&gt; add x (add y (fv_id_or_imm z'))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAddD</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSubD</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMulD</span>(x, y) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDivD</span>(x, y) -&gt; [x; y]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y', e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y', e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span>(x, y', e1, e2) -&gt; add x (add_list (fv_id_or_imm y') (add_list (fv e1) (fv e2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFEq</span>(x, y, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFLE</span>(x, y, e1, e2) -&gt; add x (add y (add_list (fv e1) (fv e2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallCls</span>(x, ys, zs) -&gt; add x (add_list ys zs)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallDir</span>(_, ys, zs) -&gt; add_list ys zs
<a name="sparcasm_exclude"></a><span style="color:green">and</span> fv = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span>(exp) -&gt; fv_exp exp
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t), exp, e) -&gt; add_list (fv_exp exp) (remove x (fv e))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span>(x, e) -&gt; remove x (fv e) <span style="color:#990000">(* Spillされた変数は、自由変数の計算から除外 *)</span>
    <span style="color:#990000">(* [XXX] (if y = z then (forget x; ...) else (forget x; ...)); x + x</span>
<span style="color:#990000">       のように、ifのthen節とelse節の両方でxがforgetされている場合は、</span>
<span style="color:#990000">       eの自由変数からxを除いても良いが、ここではそうしないことにする。</span>
<span style="color:#990000">       つまり、ifでは変数はforgetされない(かもしれない)と近似する。 *)</span>

<span style="color:green">let</span> <span style="color:green">rec</span> concat e1 xt e2 =
  <span style="color:#77aaaa">match</span> e1 <span style="color:#77aaaa">with</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span>(exp) -&gt; <span style="color:#0033cc">Let</span>(xt, exp, e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(yt, exp, e1') -&gt; <span style="color:#0033cc">Let</span>(yt, exp, concat e1' xt e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span>(y, e1') -&gt; <span style="color:#0033cc">Forget</span>(y, concat e1' xt e2)

<span style="color:green">let</span> align i = (<span style="color:#77aaaa">if</span> i <span style="color:#808080">mod</span> 8 = 0 <span style="color:#77aaaa">then</span> i <span style="color:#77aaaa">else</span> i + 4)
</pre>

<hr>
<h1><code>virtual.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">Closure</span>.prog -&gt; <span style="color:#0033cc">SparcAsm</span>.prog
</pre>

<hr>
<h1><code>virtual.ml</code></h1>

<pre><span style="color:#990000">(* translation into SPARC assembly with infinite number of virtual registers *)</span>
<a name="virtual_data"></a>
<span style="color:#cc9900">open</span> <span style="color:#0033cc">SparcAsm</span>

<span style="color:green">let</span> data = ref [] <span style="color:#990000">(* 浮動小数の定数テーブル *)</span>

<span style="color:green">let</span> classify xts ini addf addi =
  <span style="color:#0033cc">List</span>.fold_left
    (<span style="color:green">fun</span> acc (x, t) -&gt;
      <span style="color:#77aaaa">match</span> t <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; acc
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; addf acc x
      <span style="color:#77aaaa">|</span> _ -&gt; addi acc x t)
    ini
    xts

<span style="color:green">let</span> separate xts =
  classify
    xts
    ([], [])
    (<span style="color:green">fun</span> (int, float) x -&gt; (int, float @ [x]))
    (<span style="color:green">fun</span> (int, float) x _ -&gt; (int @ [x], float))

<span style="color:green">let</span> expand xts ini addf addi =
  classify
    xts
    ini
    (<span style="color:green">fun</span> (offset, acc) x -&gt;
      <span style="color:green">let</span> offset = align offset  <span style="color:green">in</span>
      (offset + 8, addf x offset acc))
<a name="virtual_g"></a>    (<span style="color:green">fun</span> (offset, acc) x t -&gt;
      (offset + 4, addi x t offset acc))

<span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* 式の仮想マシンコード生成 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Int</span>(i) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Set</span>(i))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Float</span>(d) -&gt;
      <span style="color:green">let</span> l =
        <span style="color:#77aaaa">try</span>
          <span style="color:#990000">(* すでに定数テーブルにあったら再利用 *)</span>
          <span style="color:green">let</span> (l, _) = <span style="color:#0033cc">List</span>.find (<span style="color:green">fun</span> (_, d') -&gt; d = d') !data <span style="color:green">in</span>
          l
        <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt;
          <span style="color:green">let</span> l = <span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(<span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"l"</span>) <span style="color:green">in</span>
          data := (l, d) :: !data;
          l <span style="color:green">in</span>
      <span style="color:green">let</span> x = <span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"l"</span> <span style="color:green">in</span>
      <span style="color:#0033cc">Let</span>((x, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">SetL</span>(l), <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">LdDF</span>(x, <span style="color:#0033cc">C</span>(0))))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Neg</span>(x) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Neg</span>(x))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Add</span>(x, y) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Add</span>(x, <span style="color:#0033cc">V</span>(y)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Sub</span>(x, y) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Sub</span>(x, <span style="color:#0033cc">V</span>(y)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">FNeg</span>(x) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FNegD</span>(x))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">FAdd</span>(x, y) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FAddD</span>(x, y))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">FSub</span>(x, y) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FSubD</span>(x, y))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">FMul</span>(x, y) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FMulD</span>(x, y))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">FDiv</span>(x, y) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FDivD</span>(x, y))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">IfEq</span>(x, y, e1, e2) -&gt;
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">IfEq</span>(x, <span style="color:#0033cc">V</span>(y), g env e1, g env e2))
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">IfFEq</span>(x, y, g env e1, g env e2))
      <span style="color:#77aaaa">|</span> _ -&gt; failwith <span style="color:#aa4444">"equality supported only for bool, int, and float"</span>)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">IfLE</span>(x, y, e1, e2) -&gt;
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Bool</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">IfLE</span>(x, <span style="color:#0033cc">V</span>(y), g env e1, g env e2))
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">IfFLE</span>(x, y, g env e1, g env e2))
      <span style="color:#77aaaa">|</span> _ -&gt; failwith <span style="color:#aa4444">"inequality supported only for bool, int and float"</span>)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Let</span>((x, t1), e1, e2) -&gt;
      <span style="color:green">let</span> e1' = g env e1 <span style="color:green">in</span>
      <span style="color:green">let</span> e2' = g (<span style="color:#0033cc">M</span>.add x t1 env) e2 <span style="color:green">in</span>
      concat e1' (x, t1) e2'
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Var</span>(x) -&gt;
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span>
<a name="virtual_makecls"></a>      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>)
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FMovD</span>(x))
      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Mov</span>(x)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">MakeCls</span>(bindings, e2) -&gt; <span style="color:#990000">(* クロージャの生成 *)</span>
      <span style="color:#990000">(* Closureのアドレスをセットしてから、自由変数の値をストア *)</span>
      <span style="color:green">let</span> env' = <span style="color:#0033cc">M</span>.add_list (<span style="color:#0033cc">List</span>.map fst bindings) env <span style="color:green">in</span>
      <span style="color:green">let</span> (set_addr, store_fv) = <span style="color:#990000">(* コードを挿入する関数たち *)</span>
        <span style="color:#0033cc">List</span>.fold_left
          (<span style="color:green">fun</span> (set_addr, store_fv) -&gt;
            <span style="color:green">fun</span> ((x, t), { <span style="color:#0033cc">Closure</span>.entry = l; <span style="color:#0033cc">Closure</span>.actual_fv = ys }) -&gt;
              <span style="color:green">let</span> (offset, store_fv) =
                expand
                  (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; (y, <span style="color:#0033cc">M</span>.find y env')) ys)
                  (4, store_fv)
                  (<span style="color:green">fun</span> y offset store_fv -&gt;
                    <span style="color:green">fun</span> e0 -&gt;
                      store_fv
                        (seq(<span style="color:#0033cc">StDF</span>(y, x, <span style="color:#0033cc">C</span>(offset)),
                             e0)))
                  (<span style="color:green">fun</span> y _ offset store_fv -&gt;
                    <span style="color:green">fun</span> e0 -&gt;
                      store_fv
                        (seq(<span style="color:#0033cc">St</span>(y, x, <span style="color:#0033cc">C</span>(offset)),
                             e0))) <span style="color:green">in</span>
              ((<span style="color:green">fun</span> e0 -&gt;
                set_addr
                  (<span style="color:#0033cc">Let</span>((x, t), <span style="color:#0033cc">Mov</span>(reg_hp),
                       <span style="color:#0033cc">Let</span>((reg_hp, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">Add</span>(reg_hp, <span style="color:#0033cc">C</span>(align offset)),
                           e0)))),
               <span style="color:green">let</span> z = <span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"l"</span> <span style="color:green">in</span>
               (<span style="color:green">fun</span> e0 -&gt;
                 store_fv
                   (<span style="color:#0033cc">Let</span>((z, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">SetL</span>(l),
                        seq(<span style="color:#0033cc">St</span>(z, x, <span style="color:#0033cc">C</span>(0)),
                            e0))))))
          ((<span style="color:green">fun</span> e0 -&gt; e0), (<span style="color:green">fun</span> e0 -&gt; e0))
          bindings <span style="color:green">in</span>
      set_addr (store_fv (g env' e2))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">AppCls</span>(x, ys) -&gt;
      <span style="color:green">let</span> (int, float) = separate (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; (y, <span style="color:#0033cc">M</span>.find y env)) ys) <span style="color:green">in</span>
      <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">CallCls</span>(x, int, float))
<a name="virtual_tuple"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">AppDir</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), ys) -&gt;
      <span style="color:green">let</span> (int, float) = separate (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; (y, <span style="color:#0033cc">M</span>.find y env)) ys) <span style="color:green">in</span>
      <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">CallDir</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), int, float))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Tuple</span>(xs) -&gt; <span style="color:#990000">(* 組の生成 *)</span>
      <span style="color:green">let</span> (offset, store) = <span style="color:#990000">(* コードを挿入する関数 *)</span>
        expand
          (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> x -&gt; (x, <span style="color:#0033cc">M</span>.find x env)) xs)
          (0, (<span style="color:green">fun</span> e0 -&gt; e0))
          (<span style="color:green">fun</span> x offset store -&gt;
            <span style="color:green">fun</span> e0 -&gt;
              store
                (seq(<span style="color:#0033cc">StDF</span>(x, reg_hp, <span style="color:#0033cc">C</span>(offset)),
                     e0)))
          (<span style="color:green">fun</span> x _ offset store -&gt;
            <span style="color:green">fun</span> e0 -&gt;
              store
                (seq(<span style="color:#0033cc">St</span>(x, reg_hp, <span style="color:#0033cc">C</span>(offset)),
                     e0))) <span style="color:green">in</span>
      <span style="color:green">let</span> y = <span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"t"</span> <span style="color:green">in</span>
      store
        (<span style="color:#0033cc">Let</span>((y, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Tuple</span>(<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> x -&gt; <span style="color:#0033cc">M</span>.find x env) xs)), <span style="color:#0033cc">Mov</span>(reg_hp),
             <span style="color:#0033cc">Let</span>((reg_hp, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">Add</span>(reg_hp, <span style="color:#0033cc">C</span>(align offset)),
                 <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Mov</span>(y)))))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">LetTuple</span>(xts, y, e2) -&gt;
      <span style="color:green">let</span> (offset, load) = <span style="color:#990000">(* コードを挿入する関数 *)</span>
        expand
          xts
          (0, (<span style="color:green">fun</span> e0 -&gt; e0))
          (<span style="color:green">fun</span> x offset load -&gt;
            <span style="color:#77aaaa">if</span> not (<span style="color:#0033cc">S</span>.mem x (<span style="color:#0033cc">Closure</span>.fv e2)) <span style="color:#77aaaa">then</span> load <span style="color:#77aaaa">else</span> <span style="color:#990000">(* [XX] a little ad hoc optimization *)</span>
            <span style="color:green">fun</span> e0 -&gt;
              load
                (fletd(x, <span style="color:#0033cc">LdDF</span>(y, <span style="color:#0033cc">C</span>(offset)),
                       e0)))
          (<span style="color:green">fun</span> x t offset load -&gt;
            <span style="color:#77aaaa">if</span> not (<span style="color:#0033cc">S</span>.mem x (<span style="color:#0033cc">Closure</span>.fv e2)) <span style="color:#77aaaa">then</span> load <span style="color:#77aaaa">else</span> <span style="color:#990000">(* [XX] a little ad hoc optimization *)</span>
            <span style="color:green">fun</span> e0 -&gt;
              load
<a name="virtual_get"></a>                (<span style="color:#0033cc">Let</span>((x, t), <span style="color:#0033cc">Ld</span>(y, <span style="color:#0033cc">C</span>(offset)),
                     e0))) <span style="color:green">in</span>
      load (g (<span style="color:#0033cc">M</span>.add_list xts env) e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Get</span>(x, y) -&gt; <span style="color:#990000">(* 配列の読み出し *)</span>
      <span style="color:green">let</span> offset = <span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"o"</span> <span style="color:green">in</span>
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>)
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>) -&gt;
          <span style="color:#0033cc">Let</span>((offset, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">SLL</span>(y, <span style="color:#0033cc">C</span>(3)),
              <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">LdDF</span>(x, <span style="color:#0033cc">V</span>(offset))))
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(_) -&gt;
          <span style="color:#0033cc">Let</span>((offset, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">SLL</span>(y, <span style="color:#0033cc">C</span>(2)),
              <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Ld</span>(x, <span style="color:#0033cc">V</span>(offset))))
      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Put</span>(x, y, z) -&gt;
      <span style="color:green">let</span> offset = <span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"o"</span> <span style="color:green">in</span>
      (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">M</span>.find x env <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>)
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(<span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>) -&gt;
          <span style="color:#0033cc">Let</span>((offset, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">SLL</span>(y, <span style="color:#0033cc">C</span>(3)),
              <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">StDF</span>(z, x, <span style="color:#0033cc">V</span>(offset))))
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Array</span>(_) -&gt;
          <span style="color:#0033cc">Let</span>((offset, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>), <span style="color:#0033cc">SLL</span>(y, <span style="color:#0033cc">C</span>(2)),
              <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">St</span>(z, x, <span style="color:#0033cc">V</span>(offset))))
<a name="virtual_h"></a>      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">ExtArray</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x)) -&gt; <span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">SetL</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(<span style="color:#aa4444">"min_caml_"</span> ^ x)))

<span style="color:#990000">(* 関数の仮想マシンコード生成 *)</span>
<span style="color:green">let</span> h { <span style="color:#0033cc">Closure</span>.name = (<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), t); <span style="color:#0033cc">Closure</span>.args = yts; <span style="color:#0033cc">Closure</span>.formal_fv = zts; <span style="color:#0033cc">Closure</span>.body = e } =
  <span style="color:green">let</span> (int, float) = separate yts <span style="color:green">in</span>
  <span style="color:green">let</span> (offset, load) = <span style="color:#990000">(* コードを挿入する関数 *)</span>
    expand
      zts
      (4, (<span style="color:green">fun</span> e0 -&gt; e0))
      (<span style="color:green">fun</span> z offset load -&gt;
        <span style="color:green">fun</span> e0 -&gt;
          load
            (fletd(z, <span style="color:#0033cc">LdDF</span>(reg_cl, <span style="color:#0033cc">C</span>(offset)),
                   e0)))
      (<span style="color:green">fun</span> z t offset load -&gt;
        <span style="color:green">fun</span> e0 -&gt;
          load
            (<span style="color:#0033cc">Let</span>((z, t), <span style="color:#0033cc">Ld</span>(reg_cl, <span style="color:#0033cc">C</span>(offset)),
                 e0))) <span style="color:green">in</span>
  <span style="color:green">let</span> e' = load (g (<span style="color:#0033cc">M</span>.add_list yts (<span style="color:#0033cc">M</span>.add_list zts <span style="color:#0033cc">M</span>.empty)) e) <span style="color:green">in</span>
  <span style="color:green">let</span> t2 =
    <span style="color:#77aaaa">match</span> t <span style="color:#77aaaa">with</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Fun</span>(_, t2) -&gt; t2
<a name="virtual_f"></a>    <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false <span style="color:green">in</span>
  { name = <span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x); args = int; fargs = float; body = e'; ret = t2 }

<span style="color:#990000">(* プログラム全体の仮想マシンコード生成 *)</span>
<span style="color:green">let</span> f (<span style="color:#0033cc">Closure</span>.<span style="color:#0033cc">Prog</span>(fundefs, e)) =
  data := [];
  <span style="color:green">let</span> fundefs = <span style="color:#0033cc">List</span>.map h fundefs <span style="color:green">in</span>
  <span style="color:green">let</span> e = g <span style="color:#0033cc">M</span>.empty e <span style="color:green">in</span>
  <span style="color:#0033cc">Prog</span>(!data, fundefs, e)
</pre>

<hr>
<h1><code>simm13.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">SparcAsm</span>.prog -&gt; <span style="color:#0033cc">SparcAsm</span>.prog
</pre>

<hr>
<h1><code>simm13.ml</code></h1>
<a name="simm13_g"></a>
<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">SparcAsm</span>

<span style="color:green">let</span> <span style="color:green">rec</span> g env = <span style="color:green">function</span> <span style="color:#990000">(* 命令列の13bit即値最適化 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span>(exp) -&gt; <span style="color:#0033cc">Ans</span>(g' env exp)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t) <span style="color:green">as</span> xt, <span style="color:#0033cc">Set</span>(i), e) <span style="color:#77aaaa">when</span> (-4096 &lt;= i) &amp;&amp; (i &lt; 4096) -&gt;
      <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"found simm13 %s = %d@."</span> x i;
      <span style="color:green">let</span> e' = g (<span style="color:#0033cc">M</span>.add x i env) e <span style="color:green">in</span>
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.mem x (fv e') <span style="color:#77aaaa">then</span> <span style="color:#0033cc">Let</span>(xt, <span style="color:#0033cc">Set</span>(i), e') <span style="color:#77aaaa">else</span>
      (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"erased redundant Set to %s@."</span> x;
       e')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t) <span style="color:green">as</span> xt, <span style="color:#0033cc">SLL</span>(y, <span style="color:#0033cc">C</span>(i)), e) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#990000">(* for array access *)</span>
      <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"erased redundant SLL on %s@."</span> x;
<a name="simm13_gprime"></a>      g env (<span style="color:#0033cc">Let</span>(xt, <span style="color:#0033cc">Set</span>((<span style="color:#0033cc">M</span>.find y env) <span style="color:#808080">lsl</span> i), e))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t) <span style="color:green">as</span> xt, exp, e) -&gt; <span style="color:#0033cc">Let</span>(xt, g' env exp, g env e)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span>(x, e) -&gt; <span style="color:#0033cc">Forget</span>(x, g env e)
<span style="color:green">and</span> g' env = <span style="color:green">function</span> <span style="color:#990000">(* 各命令の13bit即値最適化 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, <span style="color:#0033cc">V</span>(y)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">Add</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, <span style="color:#0033cc">V</span>(y)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#0033cc">Add</span>(y, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find x env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, <span style="color:#0033cc">V</span>(y)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">Sub</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SLL</span>(x, <span style="color:#0033cc">V</span>(y)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">SLL</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ld</span>(x, <span style="color:#0033cc">V</span>(y)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">Ld</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">St</span>(x, y, <span style="color:#0033cc">V</span>(z)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem z env -&gt; <span style="color:#0033cc">St</span>(x, y, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find z env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LdDF</span>(x, <span style="color:#0033cc">V</span>(y)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">LdDF</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">StDF</span>(x, y, <span style="color:#0033cc">V</span>(z)) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem z env -&gt; <span style="color:#0033cc">StDF</span>(x, y, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find z env))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, <span style="color:#0033cc">V</span>(y), e1, e2) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">IfEq</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env), g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, <span style="color:#0033cc">V</span>(y), e1, e2) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">IfLE</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env), g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span>(x, <span style="color:#0033cc">V</span>(y), e1, e2) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem y env -&gt; <span style="color:#0033cc">IfGE</span>(x, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find y env), g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, <span style="color:#0033cc">V</span>(y), e1, e2) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#0033cc">IfEq</span>(y, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find x env), g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, <span style="color:#0033cc">V</span>(y), e1, e2) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#0033cc">IfGE</span>(y, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find x env), g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span>(x, <span style="color:#0033cc">V</span>(y), e1, e2) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">M</span>.mem x env -&gt; <span style="color:#0033cc">IfLE</span>(y, <span style="color:#0033cc">C</span>(<span style="color:#0033cc">M</span>.find x env), g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y', e1, e2) -&gt; <span style="color:#0033cc">IfEq</span>(x, y', g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y', e1, e2) -&gt; <span style="color:#0033cc">IfLE</span>(x, y', g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span>(x, y', e1, e2) -&gt; <span style="color:#0033cc">IfGE</span>(x, y', g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFEq</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfFEq</span>(x, y, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFLE</span>(x, y, e1, e2) -&gt; <span style="color:#0033cc">IfFLE</span>(x, y, g env e1, g env e2)
  <span style="color:#77aaaa">|</span> e -&gt; e

<span style="color:green">let</span> h { name = l; args = xs; fargs = ys; body = e; ret = t } = <span style="color:#990000">(* トップレベル関数の13bit即値最適化 *)</span>
  { name = l; args = xs; fargs = ys; body = g <span style="color:#0033cc">M</span>.empty e; ret = t }

<span style="color:green">let</span> f (<span style="color:#0033cc">Prog</span>(data, fundefs, e)) = <span style="color:#990000">(* プログラム全体の13bit即値最適化 *)</span>
  <span style="color:#0033cc">Prog</span>(data, <span style="color:#0033cc">List</span>.map h fundefs, g <span style="color:#0033cc">M</span>.empty e)
</pre>

<hr>
<h1><code>regAlloc.mli</code></h1>

<pre><span style="color:green">val</span> f : <span style="color:#0033cc">SparcAsm</span>.prog -&gt; <span style="color:#0033cc">SparcAsm</span>.prog
</pre>

<hr>
<h1><code>regAlloc.ml</code></h1>

<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">SparcAsm</span>

<span style="color:#990000">(* for register coalescing *)</span>
<span style="color:#990000">(* [XXX] Callがあったら、そこから先は無意味というか逆効果なので追わない。</span>
<span style="color:#990000">         そのために「Callがあったかどうか」を返り値の第1要素に含める。 *)</span>
<span style="color:green">let</span> <span style="color:green">rec</span> target' src (dest, t) = <span style="color:green">function</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Mov</span>(x) <span style="color:#77aaaa">when</span> x = src &amp;&amp; is_reg dest -&gt;
      <span style="color:#cc9900">assert</span> (t &lt;&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>);
      <span style="color:#cc9900">assert</span> (t &lt;&gt; <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>);
      false, [dest]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMovD</span>(x) <span style="color:#77aaaa">when</span> x = src &amp;&amp; is_reg dest -&gt;
      <span style="color:#cc9900">assert</span> (t = <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span>);
      false, [dest]
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(_, _, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(_, _, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span>(_, _, e1, e2)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFEq</span>(_, _, e1, e2) <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFLE</span>(_, _, e1, e2) -&gt;
      <span style="color:green">let</span> c1, rs1 = target src (dest, t) e1 <span style="color:green">in</span>
      <span style="color:green">let</span> c2, rs2 = target src (dest, t) e2 <span style="color:green">in</span>
      c1 &amp;&amp; c2, rs1 @ rs2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallCls</span>(x, ys, zs) -&gt;
      true, (target_args src regs 0 ys @
             target_args src fregs 0 zs @
             <span style="color:#77aaaa">if</span> x = src <span style="color:#77aaaa">then</span> [reg_cl] <span style="color:#77aaaa">else</span> [])
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallDir</span>(_, ys, zs) -&gt;
<a name="regalloc_target"></a>      true, (target_args src regs 0 ys @
             target_args src fregs 0 zs)
  <span style="color:#77aaaa">|</span> _ -&gt; false, []
<span style="color:green">and</span> target src dest = <span style="color:green">function</span> <span style="color:#990000">(* register targeting *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span>(exp) -&gt; target' src dest exp
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>(xt, exp, e) -&gt;
      <span style="color:green">let</span> c1, rs1 = target' src xt exp <span style="color:green">in</span>
      <span style="color:#77aaaa">if</span> c1 <span style="color:#77aaaa">then</span> true, rs1 <span style="color:#77aaaa">else</span>
      <span style="color:green">let</span> c2, rs2 = target src dest e <span style="color:green">in</span>
      c2, rs1 @ rs2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span>(_, e) -&gt; target src dest e
<span style="color:green">and</span> target_args src all n = <span style="color:green">function</span> <span style="color:#990000">(* auxiliary function for Call *)</span>
  <span style="color:#77aaaa">|</span> [] -&gt; []
  <span style="color:#77aaaa">|</span> y :: ys <span style="color:#77aaaa">when</span> src = y -&gt; all.(n) :: target_args src all (n + 1) ys
  <span style="color:#77aaaa">|</span> _ :: ys -&gt; target_args src all (n + 1) ys

<span style="color:green">type</span> alloc_result = <span style="color:#990000">(* allocにおいてspillingがあったかどうかを表すデータ型 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Alloc</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* allocated register *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Spill</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* spilled variable *)</span>
<span style="color:green">let</span> <span style="color:green">rec</span> alloc_or_spill dest cont regenv all x =
  <span style="color:#990000">(* allocate a register or spill a variable *)</span>
  <span style="color:#cc9900">assert</span> (not (<span style="color:#0033cc">M</span>.mem x regenv));
  <span style="color:#77aaaa">if</span> all = [<span style="color:#aa4444">"%g0"</span>] <span style="color:#77aaaa">then</span> <span style="color:#0033cc">Alloc</span>(<span style="color:#aa4444">"%g0"</span>) <span style="color:#77aaaa">else</span> <span style="color:#990000">(* [XX] ad hoc optimization *)</span>
  <span style="color:#77aaaa">if</span> is_reg x <span style="color:#77aaaa">then</span> <span style="color:#0033cc">Alloc</span>(x) <span style="color:#77aaaa">else</span>
  <span style="color:green">let</span> free = fv cont <span style="color:green">in</span>
  <span style="color:#77aaaa">try</span>
    <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"allocating %s@."</span> x;
    <span style="color:green">let</span> (c, prefer) = target x dest cont <span style="color:green">in</span>
    <span style="color:green">let</span> live = <span style="color:#990000">(* 生きているレジスタ *)</span>
      <span style="color:#0033cc">List</span>.fold_left
        (<span style="color:green">fun</span> live y -&gt;
          <span style="color:#77aaaa">if</span> is_reg y <span style="color:#77aaaa">then</span> <span style="color:#0033cc">S</span>.add y live <span style="color:#77aaaa">else</span>
          <span style="color:#77aaaa">try</span> <span style="color:#0033cc">S</span>.add (<span style="color:#0033cc">M</span>.find y regenv) live
          <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; live)
        <span style="color:#0033cc">S</span>.empty
        free <span style="color:green">in</span>
    <span style="color:green">let</span> r = <span style="color:#990000">(* そうでないレジスタを探す *)</span>
      <span style="color:#0033cc">List</span>.find
        (<span style="color:green">fun</span> r -&gt; not (<span style="color:#0033cc">S</span>.mem r live))
        (prefer @ all) <span style="color:green">in</span>
    <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"allocated %s to %s@."</span> x r;
    <span style="color:#0033cc">Alloc</span>(r)
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt;
    <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"register allocation failed for %s@."</span> x;
    <span style="color:green">let</span> y = <span style="color:#990000">(* 型の合うレジスタ変数を探す *)</span>
      <span style="color:#0033cc">List</span>.find
        (<span style="color:green">fun</span> y -&gt;
          not (is_reg y) &amp;&amp;
          <span style="color:#77aaaa">try</span> <span style="color:#0033cc">List</span>.mem (<span style="color:#0033cc">M</span>.find y regenv) all
          <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; false)
        (<span style="color:#0033cc">List</span>.rev free) <span style="color:green">in</span>
    <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"spilling %s from %s@."</span> y (<span style="color:#0033cc">M</span>.find y regenv);
    <span style="color:#0033cc">Spill</span>(y)

<span style="color:#990000">(* auxiliary function for g and g'_and_unspill *)</span>
<span style="color:green">let</span> add x r regenv =
<a name="regalloc_result"></a>  <span style="color:#77aaaa">if</span> is_reg x <span style="color:#77aaaa">then</span> (<span style="color:#cc9900">assert</span> (x = r); regenv) <span style="color:#77aaaa">else</span>
  <span style="color:#0033cc">M</span>.add x r regenv

<span style="color:green">type</span> g_result = <span style="color:#990000">(* gやg'においてspillingがあったかどうかを表すデータ型 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NoSpill</span> <span style="color:green">of</span> t * <span style="color:#0033cc">Id</span>.t <span style="color:#0033cc">M</span>.t <span style="color:#990000">(* new regenv *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span> <span style="color:green">of</span> t * <span style="color:#0033cc">Id</span>.t list <span style="color:#990000">(* spilled variables *)</span>

<span style="color:#990000">(* auxiliary functions for g' *)</span>
<span style="color:green">exception</span> <span style="color:#0033cc">NoReg</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t * <span style="color:#0033cc">Type</span>.t
<span style="color:green">let</span> find x t regenv =
  <span style="color:#77aaaa">if</span> is_reg x <span style="color:#77aaaa">then</span> x <span style="color:#77aaaa">else</span>
  <span style="color:#77aaaa">try</span> <span style="color:#0033cc">M</span>.find x regenv
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; raise (<span style="color:#0033cc">NoReg</span>(x, t))
<span style="color:green">let</span> find' x' regenv =
  <span style="color:#77aaaa">match</span> x' <span style="color:#77aaaa">with</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">V</span>(x) -&gt; <span style="color:#0033cc">V</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv)
  <span style="color:#77aaaa">|</span> c -&gt; c
<span style="color:green">let</span> forget_list xs e =
  <span style="color:#0033cc">List</span>.fold_left
    (<span style="color:green">fun</span> e x -&gt; <span style="color:#0033cc">Forget</span>(x, e))
    e
    xs
<span style="color:green">let</span> insert_forget xs exp t =
  <span style="color:green">let</span> constr =
    <span style="color:#77aaaa">match</span> t <span style="color:#77aaaa">with</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; (<span style="color:green">fun</span> a -&gt; <span style="color:#0033cc">Nop</span>)
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; (<span style="color:green">fun</span> a -&gt; <span style="color:#0033cc">FMovD</span>(a))
    <span style="color:#77aaaa">|</span> _ -&gt; (<span style="color:green">fun</span> a -&gt; <span style="color:#0033cc">Mov</span>(a)) <span style="color:green">in</span>
  <span style="color:green">let</span> a = <span style="color:#0033cc">Id</span>.gentmp t <span style="color:green">in</span>
  <span style="color:#0033cc">ToSpill</span>(<span style="color:#0033cc">Let</span>((a, t), exp,
<a name="regalloc_g"></a>              forget_list xs (<span style="color:#0033cc">Ans</span>(constr a))),
          xs)

<span style="color:green">let</span> <span style="color:green">rec</span> g dest cont regenv = <span style="color:green">function</span> <span style="color:#990000">(* 命令列のレジスタ割り当て *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ans</span>(exp) -&gt; g'_and_unspill dest cont regenv exp
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Let</span>((x, t) <span style="color:green">as</span> xt, exp, e) -&gt;
      <span style="color:#cc9900">assert</span> (not (<span style="color:#0033cc">M</span>.mem x regenv));
      <span style="color:green">let</span> cont' = concat e dest cont <span style="color:green">in</span>
      (<span style="color:#77aaaa">match</span> g'_and_unspill xt cont' regenv exp <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span>(e1, ys) -&gt; <span style="color:#0033cc">ToSpill</span>(concat e1 xt e, ys)
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NoSpill</span>(e1', regenv1) -&gt;
          <span style="color:green">let</span> all =
            <span style="color:#77aaaa">match</span> t <span style="color:#77aaaa">with</span>
            <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; [<span style="color:#aa4444">"%g0"</span>] <span style="color:#990000">(* dummy *)</span>
            <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; allfregs
            <span style="color:#77aaaa">|</span> _ -&gt; allregs <span style="color:green">in</span>
          (<span style="color:#77aaaa">match</span> alloc_or_spill dest cont' regenv1 all x <span style="color:#77aaaa">with</span>
          <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Spill</span>(y) -&gt; <span style="color:#0033cc">ToSpill</span>(<span style="color:#0033cc">Let</span>(xt, exp, <span style="color:#0033cc">Forget</span>(y, e)), [y])
          <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Alloc</span>(r) -&gt;
              <span style="color:#77aaaa">match</span> g dest cont (add x r regenv1) e <span style="color:#77aaaa">with</span>
              <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span>(e2, ys) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">List</span>.mem x ys -&gt;
                  <span style="color:green">let</span> x_saved = <span style="color:#0033cc">Let</span>(xt, exp, seq(<span style="color:#0033cc">Save</span>(x, x), e2)) <span style="color:green">in</span>
                  (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">List</span>.filter (<span style="color:green">fun</span> y -&gt; y &lt;&gt; x) ys <span style="color:#77aaaa">with</span>
                  <span style="color:#77aaaa">|</span> [] -&gt; g dest cont regenv x_saved
                  <span style="color:#77aaaa">|</span> ys_left -&gt; <span style="color:#0033cc">ToSpill</span>(x_saved, ys_left))
              <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span>(e2, ys) -&gt; <span style="color:#0033cc">ToSpill</span>(<span style="color:#0033cc">Let</span>(xt, exp, e2), ys)
              <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NoSpill</span>(e2', regenv2) -&gt; <span style="color:#0033cc">NoSpill</span>(concat e1' (r, t) e2', regenv2)))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Forget</span>(x, e) -&gt;
      (<span style="color:#77aaaa">match</span> g dest cont (<span style="color:#0033cc">M</span>.remove x regenv) e <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span>(e1, ys) -&gt;
          <span style="color:green">let</span> x_forgotten = <span style="color:#0033cc">Forget</span>(x, e1) <span style="color:green">in</span>
          (<span style="color:#77aaaa">match</span> <span style="color:#0033cc">List</span>.filter (<span style="color:green">fun</span> y -&gt; y &lt;&gt; x) ys <span style="color:#77aaaa">with</span>
<a name="regalloc_unspill"></a>          <span style="color:#77aaaa">|</span> [] -&gt; g dest cont regenv x_forgotten
          <span style="color:#77aaaa">|</span> ys_left -&gt; <span style="color:#0033cc">ToSpill</span>(x_forgotten, ys_left))
      <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NoSpill</span>(e1', regenv1) -&gt; <span style="color:#0033cc">NoSpill</span>(e1', regenv1))
<span style="color:green">and</span> g'_and_unspill dest cont regenv exp = <span style="color:#990000">(* 使用される変数をスタックからレジスタへRestore *)</span>
  <span style="color:#77aaaa">try</span> g' dest cont regenv exp
  <span style="color:#77aaaa">with</span> <span style="color:#0033cc">NoReg</span>(x, t) -&gt;
    (<span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"unspilling %s@."</span> x;
     <span style="color:green">let</span> cont' = concat (<span style="color:#0033cc">Ans</span>(exp)) dest cont <span style="color:green">in</span>
     <span style="color:green">let</span> all =
       <span style="color:#77aaaa">match</span> t <span style="color:#77aaaa">with</span>
       <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#cc9900">assert</span> false
       <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; allfregs
       <span style="color:#77aaaa">|</span> _ -&gt; allregs <span style="color:green">in</span>
     <span style="color:#77aaaa">match</span> alloc_or_spill dest cont' regenv all x <span style="color:#77aaaa">with</span>
     <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Spill</span>(z) -&gt; <span style="color:#0033cc">ToSpill</span>(<span style="color:#0033cc">Forget</span>(z, <span style="color:#0033cc">Ans</span>(exp)), [z])
     <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Alloc</span>(r) -&gt;
<a name="regalloc_gprime"></a>         <span style="color:#77aaaa">match</span> g'_and_unspill dest cont (add x r regenv) exp <span style="color:#77aaaa">with</span>
         <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span>(e1, zs) -&gt; <span style="color:#0033cc">ToSpill</span>(e1, zs)
         <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NoSpill</span>(e1', regenv1) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Let</span>((r, t), <span style="color:#0033cc">Restore</span>(x), e1'), regenv1))
<span style="color:green">and</span> g' dest cont regenv = <span style="color:green">function</span> <span style="color:#990000">(* 各命令のレジスタ割り当て *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Nop</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Set</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SetL</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Comment</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Restore</span> _ <span style="color:green">as</span> exp -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(exp), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Mov</span>(x) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Mov</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span>(x) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Neg</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span>(x, y') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Add</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span>(x, y') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Sub</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SLL</span>(x, y') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">SLL</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ld</span>(x, y') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Ld</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">St</span>(x, y, z') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">St</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' z' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMovD</span>(x) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FMovD</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNegD</span>(x) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FNegD</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAddD</span>(x, y) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FAddD</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSubD</span>(x, y) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FSubD</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMulD</span>(x, y) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FMulD</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDivD</span>(x, y) -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">FDivD</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LdDF</span>(x, y') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">LdDF</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">StDF</span>(x, y, z') -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">StDF</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' z' regenv)), regenv)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfEq</span>(x, y', e1, e2) <span style="color:green">as</span> exp -&gt; g'_if dest cont regenv exp (<span style="color:green">fun</span> e1' e2' -&gt; <span style="color:#0033cc">IfEq</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv, e1', e2')) e1 e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfLE</span>(x, y', e1, e2) <span style="color:green">as</span> exp -&gt; g'_if dest cont regenv exp (<span style="color:green">fun</span> e1' e2' -&gt; <span style="color:#0033cc">IfLE</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv, e1', e2')) e1 e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfGE</span>(x, y', e1, e2) <span style="color:green">as</span> exp -&gt; g'_if dest cont regenv exp (<span style="color:green">fun</span> e1' e2' -&gt; <span style="color:#0033cc">IfGE</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, find' y' regenv, e1', e2')) e1 e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFEq</span>(x, y, e1, e2) <span style="color:green">as</span> exp -&gt; g'_if dest cont regenv exp (<span style="color:green">fun</span> e1' e2' -&gt; <span style="color:#0033cc">IfFEq</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, e1', e2')) e1 e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">IfFLE</span>(x, y, e1, e2) <span style="color:green">as</span> exp -&gt; g'_if dest cont regenv exp (<span style="color:green">fun</span> e1' e2' -&gt; <span style="color:#0033cc">IfFLE</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv, e1', e2')) e1 e2
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallCls</span>(x, ys, zs) <span style="color:green">as</span> exp -&gt; g'_call dest cont regenv exp (<span style="color:green">fun</span> ys zs -&gt; <span style="color:#0033cc">CallCls</span>(find x <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv, ys, zs)) ys zs
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">CallDir</span>(l, ys, zs) <span style="color:green">as</span> exp -&gt; g'_call dest cont regenv exp (<span style="color:green">fun</span> ys zs -&gt; <span style="color:#0033cc">CallDir</span>(l, ys, zs)) ys zs
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Save</span>(x, y) -&gt;
      <span style="color:#cc9900">assert</span> (x = y);
<a name="regalloc_if"></a>      <span style="color:#cc9900">assert</span> (not (is_reg x));
      <span style="color:#77aaaa">try</span> <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Save</span>(<span style="color:#0033cc">M</span>.find x regenv, x)), regenv)
      <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>), regenv) <span style="color:#990000">(* must have already been saved *)</span>
<span style="color:green">and</span> g'_if dest cont regenv exp constr e1 e2 = <span style="color:#990000">(* ifのレジスタ割り当て *)</span>
  <span style="color:green">let</span> (e1', regenv1) = g_repeat dest cont regenv e1 <span style="color:green">in</span>
  <span style="color:green">let</span> (e2', regenv2) = g_repeat dest cont regenv e2 <span style="color:green">in</span>
  <span style="color:green">let</span> regenv' = <span style="color:#990000">(* 両方に共通のレジスタ変数だけ利用 *)</span>
    <span style="color:#0033cc">List</span>.fold_left
      (<span style="color:green">fun</span> regenv' x -&gt;
        <span style="color:#77aaaa">try</span>
          <span style="color:#77aaaa">if</span> is_reg x <span style="color:#77aaaa">then</span> regenv' <span style="color:#77aaaa">else</span>
          <span style="color:green">let</span> r1 = <span style="color:#0033cc">M</span>.find x regenv1 <span style="color:green">in</span>
          <span style="color:green">let</span> r2 = <span style="color:#0033cc">M</span>.find x regenv2 <span style="color:green">in</span>
          <span style="color:#77aaaa">if</span> r1 &lt;&gt; r2 <span style="color:#77aaaa">then</span> regenv' <span style="color:#77aaaa">else</span>
          <span style="color:#0033cc">M</span>.add x r1 regenv'
        <span style="color:#77aaaa">with</span> <span style="color:#0033cc">Not_found</span> -&gt; regenv')
      <span style="color:#0033cc">M</span>.empty
      (fv cont) <span style="color:green">in</span>
  <span style="color:#77aaaa">match</span>
    <span style="color:#0033cc">List</span>.filter
      (<span style="color:green">fun</span> x -&gt; not (is_reg x) &amp;&amp; not (<span style="color:#0033cc">M</span>.mem x regenv') &amp;&amp; x &lt;&gt; fst dest)
<a name="regalloc_call"></a>      (fv cont)
  <span style="color:#77aaaa">with</span> [] -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(constr e1' e2'), regenv')
  <span style="color:#77aaaa">|</span> xs -&gt; insert_forget xs exp (snd dest) <span style="color:#990000">(* そうでない変数は分岐以前にセーブ *)</span>
<span style="color:green">and</span> g'_call dest cont regenv exp constr ys zs = <span style="color:#990000">(* 関数呼び出しのレジスタ割り当て *)</span>
  <span style="color:#77aaaa">match</span>
    <span style="color:#0033cc">List</span>.filter <span style="color:#990000">(* セーブすべきレジスタ変数を探す *)</span>
      (<span style="color:green">fun</span> x -&gt; not (is_reg x) &amp;&amp; x &lt;&gt; fst dest)
      (fv cont)
  <span style="color:#77aaaa">with</span> [] -&gt; <span style="color:#0033cc">NoSpill</span>(<span style="color:#0033cc">Ans</span>(constr
                           (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> y -&gt; find y <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span> regenv) ys)
                           (<span style="color:#0033cc">List</span>.map (<span style="color:green">fun</span> z -&gt; find z <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> regenv) zs)),
<a name="regalloc_repeat"></a>                     <span style="color:#0033cc">M</span>.empty)
  <span style="color:#77aaaa">|</span> xs -&gt; insert_forget xs exp (snd dest)

<span style="color:green">and</span> g_repeat dest cont regenv e = <span style="color:#990000">(* Spillがなくなるまでgを繰り返す *)</span>
    <span style="color:#77aaaa">match</span> g dest cont regenv e <span style="color:#77aaaa">with</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NoSpill</span>(e', regenv') -&gt; (e', regenv')
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">ToSpill</span>(e, xs) -&gt;
        g_repeat dest cont regenv
          (<span style="color:#0033cc">List</span>.fold_left
             (<span style="color:green">fun</span> e x -&gt; seq(<span style="color:#0033cc">Save</span>(x, x), e))
<a name="regalloc_h"></a>             e
             xs)

<span style="color:green">let</span> h { name = <span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x); args = ys; fargs = zs; body = e; ret = t } = <span style="color:#990000">(* 関数のレジスタ割り当て *)</span>
  <span style="color:green">let</span> regenv = <span style="color:#0033cc">M</span>.add x reg_cl <span style="color:#0033cc">M</span>.empty <span style="color:green">in</span>
  <span style="color:green">let</span> (i, arg_regs, regenv) =
    <span style="color:#0033cc">List</span>.fold_left
      (<span style="color:green">fun</span> (i, arg_regs, regenv) y -&gt;
        <span style="color:green">let</span> r = regs.(i) <span style="color:green">in</span>
        (i + 1,
         arg_regs @ [r],
         (<span style="color:#cc9900">assert</span> (not (is_reg y));
          <span style="color:#0033cc">M</span>.add y r regenv)))
      (0, [], regenv)
      ys <span style="color:green">in</span>
  <span style="color:green">let</span> (d, farg_regs, regenv) =
    <span style="color:#0033cc">List</span>.fold_left
      (<span style="color:green">fun</span> (d, farg_regs, regenv) z -&gt;
        <span style="color:green">let</span> fr = fregs.(d) <span style="color:green">in</span>
        (d + 1,
         farg_regs @ [fr],
         (<span style="color:#cc9900">assert</span> (not (is_reg z));
          <span style="color:#0033cc">M</span>.add z fr regenv)))
      (0, [], regenv)
      zs <span style="color:green">in</span>
  <span style="color:green">let</span> a =
    <span style="color:#77aaaa">match</span> t <span style="color:#77aaaa">with</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span> -&gt; <span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>
    <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Float</span> -&gt; fregs.(0)
    <span style="color:#77aaaa">|</span> _ -&gt; regs.(0) <span style="color:green">in</span>
<a name="regalloc_f"></a>  <span style="color:green">let</span> (e', regenv') = g_repeat (a, t) (<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>)) regenv e <span style="color:green">in</span>
  { name = <span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x); args = arg_regs; fargs = farg_regs; body = e'; ret = t }

<span style="color:green">let</span> f (<span style="color:#0033cc">Prog</span>(data, fundefs, e)) = <span style="color:#990000">(* プログラム全体のレジスタ割り当て *)</span>
  <span style="color:green">let</span> fundefs' = <span style="color:#0033cc">List</span>.map h fundefs <span style="color:green">in</span>
  <span style="color:green">let</span> e', regenv' = g_repeat (<span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>, <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>) (<span style="color:#0033cc">Ans</span>(<span style="color:#0033cc">Nop</span>)) <span style="color:#0033cc">M</span>.empty e <span style="color:green">in</span>
  <span style="color:#0033cc">Prog</span>(data, fundefs', e')
</pre>

<hr>
<h1><code>emit.mli</code></h1>

<pre><span style="color:green">val</span> f : out_channel -&gt; <span style="color:#0033cc">SparcAsm</span>.prog -&gt; unit
</pre>

<hr>
<h1><code>emit.ml</code></h1>

<pre><span style="color:#cc9900">open</span> <span style="color:#0033cc">SparcAsm</span>

<a name="emit_stackset"></a><span style="color:green">external</span> gethi : float -&gt; int32 = <span style="color:#aa4444">"gethi"</span>
<a name="emit_stackmap"></a><span style="color:green">external</span> getlo : float -&gt; int32 = <span style="color:#aa4444">"getlo"</span>

<span style="color:green">let</span> stackset = ref <span style="color:#0033cc">S</span>.empty <span style="color:#990000">(* すでにSaveされた変数の集合 *)</span>
<span style="color:green">let</span> stackmap = ref [] <span style="color:#990000">(* Saveされた変数の、スタックにおける位置 *)</span>
<span style="color:green">let</span> save x =
  stackset := <span style="color:#0033cc">S</span>.add x !stackset;
  <span style="color:#77aaaa">if</span> not (<span style="color:#0033cc">List</span>.mem x !stackmap) <span style="color:#77aaaa">then</span>
    stackmap := !stackmap @ [x]
<span style="color:green">let</span> savef x =
  stackset := <span style="color:#0033cc">S</span>.add x !stackset;
  <span style="color:#77aaaa">if</span> not (<span style="color:#0033cc">List</span>.mem x !stackmap) <span style="color:#77aaaa">then</span>
    (<span style="color:green">let</span> pad =
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.length !stackmap <span style="color:#808080">mod</span> 2 = 0 <span style="color:#77aaaa">then</span> [] <span style="color:#77aaaa">else</span> [<span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Int</span>] <span style="color:green">in</span>
    stackmap := !stackmap @ pad @ [x; x])
<span style="color:green">let</span> locate x =
  <span style="color:green">let</span> <span style="color:green">rec</span> loc = <span style="color:green">function</span>
    <span style="color:#77aaaa">|</span> [] -&gt; []
    <span style="color:#77aaaa">|</span> y :: zs <span style="color:#77aaaa">when</span> x = y -&gt; 0 :: <span style="color:#0033cc">List</span>.map succ (loc zs)
    <span style="color:#77aaaa">|</span> y :: zs -&gt; <span style="color:#0033cc">List</span>.map succ (loc zs) <span style="color:green">in</span>
  loc !stackmap
<span style="color:green">let</span> offset x = 4 * <span style="color:#0033cc">List</span>.hd (locate x)
<span style="color:green">let</span> stacksize () = align ((<span style="color:#0033cc">List</span>.length !stackmap + 1) * 4)

<span style="color:green">let</span> pp_id_or_imm = <span style="color:green">function</span>
<a name="emit_shuffle"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">V</span>(x) -&gt; x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">C</span>(i) -&gt; string_of_int i

<span style="color:#990000">(* 関数呼び出しのために引数を並べ替える(register shuffling) *)</span>
<span style="color:green">let</span> <span style="color:green">rec</span> shuffle sw xys =
  <span style="color:#990000">(* remove identical moves *)</span>
  <span style="color:green">let</span> id, xys = <span style="color:#0033cc">List</span>.partition (<span style="color:green">fun</span> (x, y) -&gt; x = y) xys <span style="color:green">in</span>
  <span style="color:#990000">(* find acyclic moves *)</span>
  <span style="color:green">let</span> xys, acyc = <span style="color:#0033cc">List</span>.partition (<span style="color:green">fun</span> (_, y) -&gt; <span style="color:#0033cc">List</span>.mem_assoc y xys) xys <span style="color:green">in</span>
  <span style="color:#77aaaa">match</span> xys, acyc <span style="color:#77aaaa">with</span>
  <span style="color:#77aaaa">|</span> [], [] -&gt; []
  <span style="color:#77aaaa">|</span> (x, y) :: xys, [] -&gt;
      <span style="color:#990000">(* no acyclic moves; resolve a cyclic move *)</span>
      (y, sw) ::
      (x, y) ::
      shuffle
        sw
        (<span style="color:#0033cc">List</span>.map
           (<span style="color:green">function</span>
             <span style="color:#77aaaa">|</span> (y', z) <span style="color:#77aaaa">when</span> y = y' -&gt; (sw, z)
             <span style="color:#77aaaa">|</span> yz -&gt; yz)
<a name="emit_dest"></a>           xys)
<a name="emit_g"></a>  <span style="color:#77aaaa">|</span> xys, acyc -&gt; acyc @ shuffle sw xys

<span style="color:green">type</span> dest = <span style="color:#0033cc">Tail</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span> <span style="color:green">of</span> <span style="color:#0033cc">Id</span>.t <span style="color:#990000">(* 末尾かどうかを表すデータ型 *)</span>
<span style="color:green">let</span> <span style="color:green">rec</span> g oc = <span style="color:green">function</span> <span style="color:#990000">(* 命令列のアセンブリ生成 *)</span>
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">Ans</span>(exp) -&gt; g' oc (dest, exp)
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">Let</span>((x, t), exp, e) -&gt;
<a name="emit_gprime"></a>      g' oc (<span style="color:#0033cc">NonTail</span>(x), exp);
<a name="emit_nontail"></a>      g oc (dest, e)
  <span style="color:#77aaaa">|</span> _, <span style="color:#0033cc">Forget</span> _ -&gt; <span style="color:#cc9900">assert</span> false
<span style="color:green">and</span> g' oc = <span style="color:green">function</span> <span style="color:#990000">(* 各命令のアセンブリ生成 *)</span>
  <span style="color:#990000">(* 末尾でなかったら計算結果をdestにセット *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">Nop</span> -&gt; ()
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Set</span>(i) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tset\t%d, %s\n"</span> i x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">SetL</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(y)) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tset\t%s, %s\n"</span> y x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Mov</span>(y) <span style="color:#77aaaa">when</span> x = y -&gt; ()
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Mov</span>(y) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tmov\t%s, %s\n"</span> y x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Neg</span>(y) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tneg\t%s, %s\n"</span> y x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Add</span>(y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tadd\t%s, %s, %s\n"</span> y (pp_id_or_imm z') x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Sub</span>(y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tsub\t%s, %s, %s\n"</span> y (pp_id_or_imm z') x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">SLL</span>(y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tsll\t%s, %s, %s\n"</span> y (pp_id_or_imm z') x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Ld</span>(y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tld\t[%s + %s], %s\n"</span> y (pp_id_or_imm z') x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">St</span>(x, y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tst\t%s, [%s + %s]\n"</span> x y (pp_id_or_imm z')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FMovD</span>(y) <span style="color:#77aaaa">when</span> x = y -&gt; ()
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FMovD</span>(y) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> y x;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> (co_freg y) (co_freg x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FNegD</span>(y) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfnegs\t%s, %s\n"</span> y x;
      <span style="color:#77aaaa">if</span> x &lt;&gt; y <span style="color:#77aaaa">then</span> <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> (co_freg y) (co_freg x)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FAddD</span>(y, z) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfaddd\t%s, %s, %s\n"</span> y z x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FSubD</span>(y, z) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfsubd\t%s, %s, %s\n"</span> y z x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FMulD</span>(y, z) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmuld\t%s, %s, %s\n"</span> y z x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">FDivD</span>(y, z) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfdivd\t%s, %s, %s\n"</span> y z x
<a name="emit_save"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">LdDF</span>(y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tldd\t[%s + %s], %s\n"</span> y (pp_id_or_imm z') x
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">StDF</span>(x, y, z') -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tstd\t%s, [%s + %s]\n"</span> x y (pp_id_or_imm z')
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">Comment</span>(s) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\t! %s\n"</span> s
  <span style="color:#990000">(* 退避の仮想命令の実装 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">Save</span>(x, y) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">List</span>.mem x allregs &amp;&amp; not (<span style="color:#0033cc">S</span>.mem y !stackset) -&gt;
      save y;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tst\t%s, [%s + %d]\n"</span> x reg_sp (offset y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">Save</span>(x, y) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">List</span>.mem x allfregs &amp;&amp; not (<span style="color:#0033cc">S</span>.mem y !stackset) -&gt;
<a name="emit_restore"></a>      savef y;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tstd\t%s, [%s + %d]\n"</span> x reg_sp (offset y)
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(_), <span style="color:#0033cc">Save</span>(x, y) -&gt; <span style="color:#cc9900">assert</span> (<span style="color:#0033cc">S</span>.mem y !stackset); ()
  <span style="color:#990000">(* 復帰の仮想命令の実装 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Restore</span>(y) <span style="color:#77aaaa">when</span> <span style="color:#0033cc">List</span>.mem x allregs -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tld\t[%s + %d], %s\n"</span> reg_sp (offset y) x
<a name="emit_tailret"></a>  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(x), <span style="color:#0033cc">Restore</span>(y) -&gt;
      <span style="color:#cc9900">assert</span> (<span style="color:#0033cc">List</span>.mem x allfregs);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tldd\t[%s + %d], %s\n"</span> reg_sp (offset y) x
  <span style="color:#990000">(* 末尾だったら計算結果を第一レジスタにセットしてret *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, (<span style="color:#0033cc">Nop</span> <span style="color:#77aaaa">|</span> <span style="color:#0033cc">St</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">StDF</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Comment</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Save</span> _ <span style="color:green">as</span> exp) -&gt;
      g' oc (<span style="color:#0033cc">NonTail</span>(<span style="color:#0033cc">Id</span>.gentmp <span style="color:#0033cc">Type</span>.<span style="color:#0033cc">Unit</span>), exp);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tretl\n"</span>;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, (<span style="color:#0033cc">Set</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SetL</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Mov</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Neg</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Add</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Sub</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">SLL</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Ld</span> _ <span style="color:green">as</span> exp) -&gt;
      g' oc (<span style="color:#0033cc">NonTail</span>(regs.(0)), exp);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tretl\n"</span>;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, (<span style="color:#0033cc">FMovD</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FNegD</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FAddD</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FSubD</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FMulD</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">FDivD</span> _ <span style="color:#77aaaa">|</span> <span style="color:#0033cc">LdDF</span> _  <span style="color:green">as</span> exp) -&gt;
      g' oc (<span style="color:#0033cc">NonTail</span>(fregs.(0)), exp);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tretl\n"</span>;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, (<span style="color:#0033cc">Restore</span>(x) <span style="color:green">as</span> exp) -&gt;
      (<span style="color:#77aaaa">match</span> locate x <span style="color:#77aaaa">with</span>
      <span style="color:#77aaaa">|</span> [i] -&gt; g' oc (<span style="color:#0033cc">NonTail</span>(regs.(0)), exp)
      <span style="color:#77aaaa">|</span> [i; j] <span style="color:#77aaaa">when</span> i + 1 = j -&gt; g' oc (<span style="color:#0033cc">NonTail</span>(fregs.(0)), exp)
      <span style="color:#77aaaa">|</span> _ -&gt; <span style="color:#cc9900">assert</span> false);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tretl\n"</span>;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">IfEq</span>(x, y', e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcmp\t%s, %s\n"</span> x (pp_id_or_imm y');
      g'_tail_if oc e1 e2 <span style="color:#aa4444">"be"</span> <span style="color:#aa4444">"bne"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">IfLE</span>(x, y', e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcmp\t%s, %s\n"</span> x (pp_id_or_imm y');
      g'_tail_if oc e1 e2 <span style="color:#aa4444">"ble"</span> <span style="color:#aa4444">"bg"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">IfGE</span>(x, y', e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcmp\t%s, %s\n"</span> x (pp_id_or_imm y');
      g'_tail_if oc e1 e2 <span style="color:#aa4444">"bge"</span> <span style="color:#aa4444">"bl"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">IfFEq</span>(x, y, e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfcmpd\t%s, %s\n"</span> x y;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
      g'_tail_if oc e1 e2 <span style="color:#aa4444">"fbe"</span> <span style="color:#aa4444">"fbne"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">IfFLE</span>(x, y, e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfcmpd\t%s, %s\n"</span> x y;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
      g'_tail_if oc e1 e2 <span style="color:#aa4444">"fble"</span> <span style="color:#aa4444">"fbg"</span>
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">IfEq</span>(x, y', e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcmp\t%s, %s\n"</span> x (pp_id_or_imm y');
      g'_non_tail_if oc dest e1 e2 <span style="color:#aa4444">"be"</span> <span style="color:#aa4444">"bne"</span>
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">IfLE</span>(x, y', e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcmp\t%s, %s\n"</span> x (pp_id_or_imm y');
      g'_non_tail_if oc dest e1 e2 <span style="color:#aa4444">"ble"</span> <span style="color:#aa4444">"bg"</span>
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">IfGE</span>(x, y', e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcmp\t%s, %s\n"</span> x (pp_id_or_imm y');
      g'_non_tail_if oc dest e1 e2 <span style="color:#aa4444">"bge"</span> <span style="color:#aa4444">"bl"</span>
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">IfFEq</span>(x, y, e1, e2) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfcmpd\t%s, %s\n"</span> x y;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
      g'_non_tail_if oc dest e1 e2 <span style="color:#aa4444">"fbe"</span> <span style="color:#aa4444">"fbne"</span>
  <span style="color:#77aaaa">|</span> dest, <span style="color:#0033cc">IfFLE</span>(x, y, e1, e2) -&gt;
<a name="emit_call"></a>      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfcmpd\t%s, %s\n"</span> x y;
<a name="emit_tailcall"></a>      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
      g'_non_tail_if oc dest e1 e2 <span style="color:#aa4444">"fble"</span> <span style="color:#aa4444">"fbg"</span>
  <span style="color:#990000">(* 関数呼び出しの仮想命令の実装 *)</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">CallCls</span>(x, ys, zs) -&gt; <span style="color:#990000">(* 末尾呼び出し *)</span>
      g'_args oc [(x, reg_cl)] ys zs;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tld\t[%s + 0], %s\n"</span> reg_cl reg_sw;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tjmp\t%s\n"</span> reg_sw;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">Tail</span>, <span style="color:#0033cc">CallDir</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), ys, zs) -&gt; <span style="color:#990000">(* 末尾呼び出し *)</span>
      g'_args oc [] ys zs;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tb\t%s\n"</span> x;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(a), <span style="color:#0033cc">CallCls</span>(x, ys, zs) -&gt;
      g'_args oc [(x, reg_cl)] ys zs;
      <span style="color:green">let</span> ss = stacksize () <span style="color:green">in</span>
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tst\t%s, [%s + %d]\n"</span> reg_ra reg_sp (ss - 4);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tld\t[%s + 0], %s\n"</span> reg_cl reg_sw;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcall\t%s\n"</span> reg_sw;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tadd\t%s, %d, %s\t! delay slot\n"</span> reg_sp ss reg_sp;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tsub\t%s, %d, %s\n"</span> reg_sp ss reg_sp;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tld\t[%s + %d], %s\n"</span> reg_sp (ss - 4) reg_ra;
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.mem a allregs &amp;&amp; a &lt;&gt; regs.(0) <span style="color:#77aaaa">then</span>
        <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tmov\t%s, %s\n"</span> regs.(0) a
      <span style="color:#77aaaa">else</span> <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.mem a allfregs &amp;&amp; a &lt;&gt; fregs.(0) <span style="color:#77aaaa">then</span>
        (<span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> fregs.(0) a;
         <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> (co_freg fregs.(0)) (co_freg a))
  <span style="color:#77aaaa">|</span> <span style="color:#0033cc">NonTail</span>(a), <span style="color:#0033cc">CallDir</span>(<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), ys, zs) -&gt;
      g'_args oc [] ys zs;
      <span style="color:green">let</span> ss = stacksize () <span style="color:green">in</span>
      <span style="color:green">let</span> ra = <span style="color:#0033cc">Id</span>.genid <span style="color:#aa4444">"ra"</span> <span style="color:green">in</span>
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tst\t%s, [%s + %d]\n"</span> reg_ra reg_sp (ss - 4);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tcall\t%s\n"</span> x;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tadd\t%s, %d, %s\t! delay slot\n"</span> reg_sp ss reg_sp;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tsub\t%s, %d, %s\n"</span> reg_sp ss reg_sp;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tld\t[%s + %d], %s\n"</span> reg_sp (ss - 4) reg_ra;
      <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.mem a allregs &amp;&amp; a &lt;&gt; regs.(0) <span style="color:#77aaaa">then</span>
        <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tmov\t%s, %s\n"</span> regs.(0) a
      <span style="color:#77aaaa">else</span> <span style="color:#77aaaa">if</span> <span style="color:#0033cc">List</span>.mem a allfregs &amp;&amp; a &lt;&gt; fregs.(0) <span style="color:#77aaaa">then</span>
        (<span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> fregs.(0) a;
         <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> (co_freg fregs.(0)) (co_freg a))
<span style="color:green">and</span> g'_tail_if oc e1 e2 b bn =
  <span style="color:green">let</span> b_else = <span style="color:#0033cc">Id</span>.genid (b ^ <span style="color:#aa4444">"_else"</span>) <span style="color:green">in</span>
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\t%s\t%s\n"</span> bn b_else;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
  <span style="color:green">let</span> stackset_back = !stackset <span style="color:green">in</span>
  g oc (<span style="color:#0033cc">Tail</span>, e1);
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"%s:\n"</span> b_else;
  stackset := stackset_back;
  g oc (<span style="color:#0033cc">Tail</span>, e2)
<span style="color:green">and</span> g'_non_tail_if oc dest e1 e2 b bn =
  <span style="color:green">let</span> b_else = <span style="color:#0033cc">Id</span>.genid (b ^ <span style="color:#aa4444">"_else"</span>) <span style="color:green">in</span>
  <span style="color:green">let</span> b_cont = <span style="color:#0033cc">Id</span>.genid (b ^ <span style="color:#aa4444">"_cont"</span>) <span style="color:green">in</span>
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\t%s\t%s\n"</span> bn b_else;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
  <span style="color:green">let</span> stackset_back = !stackset <span style="color:green">in</span>
  g oc (dest, e1);
  <span style="color:green">let</span> stackset1 = !stackset <span style="color:green">in</span>
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tb\t%s\n"</span> b_cont;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tnop\n"</span>;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"%s:\n"</span> b_else;
  stackset := stackset_back;
  g oc (dest, e2);
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"%s:\n"</span> b_cont;
  <span style="color:green">let</span> stackset2 = !stackset <span style="color:green">in</span>
  stackset := <span style="color:#0033cc">S</span>.inter stackset1 stackset2
<span style="color:green">and</span> g'_args oc x_reg_cl ys zs =
  <span style="color:green">let</span> (i, yrs) =
    <span style="color:#0033cc">List</span>.fold_left
      (<span style="color:green">fun</span> (i, yrs) y -&gt; (i + 1, (y, regs.(i)) :: yrs))
      (0, x_reg_cl)
      ys <span style="color:green">in</span>
  <span style="color:#0033cc">List</span>.iter
    (<span style="color:green">fun</span> (y, r) -&gt; <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tmov\t%s, %s\n"</span> y r)
    (shuffle reg_sw yrs);
  <span style="color:green">let</span> (d, zfrs) =
    <span style="color:#0033cc">List</span>.fold_left
      (<span style="color:green">fun</span> (d, zfrs) z -&gt; (d + 1, (z, fregs.(d)) :: zfrs))
      (0, [])
      zs <span style="color:green">in</span>
  <span style="color:#0033cc">List</span>.iter
    (<span style="color:green">fun</span> (z, fr) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> z fr;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tfmovs\t%s, %s\n"</span> (co_freg z) (co_freg fr))
    (shuffle reg_fsw zfrs)

<span style="color:green">let</span> h oc { name = <span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x); args = _; fargs = _; body = e; ret = _ } =
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"%s:\n"</span> x;
  stackset := <span style="color:#0033cc">S</span>.empty;
  stackmap := [];
  g oc (<span style="color:#0033cc">Tail</span>, e)

<span style="color:green">let</span> f oc (<span style="color:#0033cc">Prog</span>(data, fundefs, e)) =
  <span style="color:#0033cc">Format</span>.eprintf <span style="color:#aa4444">"generating assembly...@."</span>;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">".section\t\".rodata\"\n"</span>;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">".align\t8\n"</span>;
  <span style="color:#0033cc">List</span>.iter
    (<span style="color:green">fun</span> (<span style="color:#0033cc">Id</span>.<span style="color:#0033cc">L</span>(x), d) -&gt;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"%s:\t! %f\n"</span> x d;
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\t.long\t0x%lx\n"</span> (gethi d);
      <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\t.long\t0x%lx\n"</span> (getlo d))
    data;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">".section\t\".text\"\n"</span>;
  <span style="color:#0033cc">List</span>.iter (<span style="color:green">fun</span> fundef -&gt; h oc fundef) fundefs;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">".global\tmin_caml_start\n"</span>;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"min_caml_start:\n"</span>;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tsave\t%%sp, -112, %%sp\n"</span>; <span style="color:#990000">(* from gcc; why 112? *)</span>
  stackset := <span style="color:#0033cc">S</span>.empty;
  stackmap := [];
  g oc (<span style="color:#0033cc">NonTail</span>(<span style="color:#aa4444">"%g0"</span>), e);
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\tret\n"</span>;
  <span style="color:#0033cc">Printf</span>.fprintf oc <span style="color:#aa4444">"\trestore\n"</span>
</pre>

<hr>
<p>
<em>This document was generated using 
<a href="http://martin.jambon.free.fr/caml2html.html">caml2html</a></em>
</body>
</html>
